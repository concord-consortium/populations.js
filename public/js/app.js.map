{"version":3,"file":"public/js/app.js","sources":["app/animated-sprite.coffee","app/events.coffee","app/helpers.coffee","app/models/agent.coffee","app/models/agents/animated-agent.coffee","app/models/agents/basic-animal.coffee","app/models/agents/basic-plant.coffee","app/models/agents/fast-plant.coffee","app/models/environment.coffee","app/models/inanimate.coffee","app/models/rule.coffee","app/models/species.coffee","app/models/trait.coffee","app/state-machine.coffee","app/ui/add-organism-button.coffee","app/ui/info-view.coffee","app/ui/interactive.coffee","app/ui/ppslider.coffee","app/ui/remove-organism-button.coffee","app/ui/speed-slider.coffee","app/ui/tool-button.coffee","app/ui/toolbar.coffee","app/views/agent-view.coffee","app/views/environment-view.coffee"],"names":[],"mappings":"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","sourcesContent":["PIXI.AnimatedSprite = (sequences, firstSequence) ->\n  @sequences  = sequences\n  unless firstSequence?\n    for key of sequences\n      @currentSequence = key\n      break\n  else\n    @currentSequence = firstSequence\n\n  @frames = @sequences[@currentSequence].frames\n  @frameRate = @sequences[@currentSequence].frameRate || 60\n  @loop = @sequences[@currentSequence].loop || false\n\n  PIXI.Sprite.call this, @frames[0]\n  @anchor.x = @anchor.y = .5\n  @onComplete = null\n  @currentFrame = 0\n  @previousFrame\n  @playing = false\n  @loop = false\n  return\n\n\n#animatedSprite\nPIXI.AnimatedSprite.constructor = PIXI.AnimatedSprite\nPIXI.AnimatedSprite:: = Object.create(PIXI.Sprite::)\nPIXI.AnimatedSprite::gotoAndPlay = (where) ->\n  if Object::toString.call(where) is \"[object String]\"\n    @currentFrame = 0\n    @currentSequence = where\n    @frames = @sequences[where].frames\n    @frameRate = @sequences[where].frameRate || 60\n    @loop = @sequences[where].loop || false\n  else\n    @frames = @sequences[@currentSequence].frames\n    @currentFrame = where\n  @playing = true\n  return\n\nPIXI.AnimatedSprite::gotoAndStop = (where) ->\n  if Object::toString.call(where) is \"[object String]\"\n    @currentFrame = 0\n    @currentSequence = where\n    @frames = @sequences[where].frames\n    @frameRate = @sequences[where].frameRate || 60\n    @loop = @sequences[where].loop || false\n  else\n    @currentFrame = where\n  @setTexture @frames[@currentFrame]\n  @playing = false\n  return\n\nPIXI.AnimatedSprite::play = ->\n  @playing = true\n  return\n\nPIXI.AnimatedSprite::stop = ->\n  @playing = false\n  return\n\nPIXI.AnimatedSprite::advanceTime = (dt) ->\n  dt = 1 / 60  if typeof dt is \"undefined\"\n  if @playing\n    @currentFrame += @frameRate * dt\n    constrainedFrame = Math.floor(Math.min(@currentFrame, @frames.length - 1))\n    @setTexture @frames[constrainedFrame]\n    if @currentFrame >= @frames.length\n      if @loop\n        @gotoAndPlay 0\n      else\n        @stop()\n      @onComplete @currentSequence  if @onComplete\n  return\n","\n###\n  This is a simple helper library for dispatching custom events.\n  While not strictly necessary, it also includes a polyfill for supporting\n  event dispatching on browsers that don't have CustomEvent support.\n###\n\nmodule.exports = class Events\n  @dispatchEvent: (type, data)->\n    if document.dispatchEvent?\n      evt = new CustomEvent type, {detail: data}\n      document.dispatchEvent evt\n    else\n      console.warn(\"document doesn't support dispatchEvent!\")\n\n  @addEventListener: (type, callback)->\n    if document.addEventListener?\n      document.addEventListener(type, callback)\n    else\n      console.warn(\"document doesn't support addEventListener!\")\n\n(->\n  unless (window.CustomEvent and typeof window.CustomEvent is 'function')\n    CustomEvent = ( type, eventInitDict ) ->\n      newEvent = document.createEvent('CustomEvent')\n      newEvent.initCustomEvent(type,\n        !!(eventInitDict && eventInitDict.bubbles),\n        !!(eventInitDict && eventInitDict.cancelable),\n        (if eventInitDict then eventInitDict.detail else null))\n      return newEvent;\n\n    window.CustomEvent = CustomEvent\n)()\n\n\n(->\n  unless window.TouchEvent?\n    # Firefox > 24 doesn't expose TouchEvent to the desktop browser version. Create a class to prevent NPE's in the code.\n    console.log \"Shimming TouchEvent...\"\n    window.TouchEvent = class TouchEvent\n)()\n","# [a,b,c,d].remove(1) => [a,c,d]\n# [a,b,c,d].remove(0,2) => [d]\nArray::remove = (from, to) ->\n  rest = this.slice((to || from) + 1 || this.length)\n  this.length = if from < 0 then this.length + from else from\n  return this.push.apply(this, rest)\n\nArray::removeObj = (obj) ->\n  i = this.indexOf(obj)\n  if ~i\n    this.remove(i)\n    true\n  else\n    false\n\nArray::replaceFirst = (obj, replacement) ->\n  this[this.indexOf(obj)] = replacement\n\nArray::shuffle = ->\n  top = @length\n  if top\n    while (--top)\n      current = Math.floor(Math.random() * (top + 1))\n      tmp = this[current]\n      this[current] = this[top]\n      this[top] = tmp\n  return this\n\nArray::randomElement = ->\n  return this[Math.floor Math.random() * @length]\n\nwindow.ExtMath = {}\n\nExtMath.randomInt = (max) ->\n  Math.floor Math.random() * max\n\nExtMath.randomFloat = (max=1) ->\n  Math.random() * max\n\nExtMath.randomValue = (min, max) ->\n  min + Math.random() * (max - min)\n\nExtMath.randomGaussianIrwinHall = (opts={}) ->\n  opts.mean = 0 unless opts.mean?\n  opts.deviation = 1 unless opts.deviation?\n\n  # a 12th order Irwin-Hall distribution, which is a close approximation of a\n  # standard normal distribution and is faster than other typical methods.\n  v = 0\n  for i in [1..12]\n    v += (Math.random() - 0.5)\n  return v * opts.deviation + opts.mean\n\nExtMath._haveNextNextGuassian = false\nExtMath._nextNextGuassian = 0\nExtMath.randomGaussianJava = (opts={}) ->\n  if ExtMath._haveNextNextGaussian\n    ExtMath._haveNextNextGaussian = false\n    return ExtMath._nextNextGaussian\n  else\n    s = 0\n    while s >= 1 or s is 0\n      v1 = 2 * Math.random() - 1   # between -1.0 and 1.0\n      v2 = 2 * Math.random() - 1   # between -1.0 and 1.0\n      s = v1 * v1 + v2 * v2\n    multiplier = Math.sqrt(-2 * Math.log(s)/s)\n    ExtMath._nextNextGaussian = v2 * multiplier\n    ExtMath._haveNextNextGaussian = true\n    return v1 * multiplier\n\nExtMath.randomGaussian= (opts={}) ->\n  # return ExtMath.randomGaussianIrwinHall(opts)\n  return ExtMath.randomGaussianJava(opts)\n\nExtMath.flip = ->\n  ExtMath.randomInt(2)\n\nExtMath.HALF_PI = Math.PI / 2\nExtMath.TWO_PI  = Math.PI * 2\n\nExtMath.normalizeRads = (t) ->\n  t - ExtMath.TWO_PI * Math.floor((t + Math.PI) / ExtMath.TWO_PI)\n\nExtMath.distanceSquared = (p1, p2) ->\n  dx = p1.x - p2.x\n  dy = p1.y - p2.y\n  return (dx*dx + dy*dy)\n\nmodule.exports =\n\n  ###\n    Given an object of default values:\n    defaultOptions = {\n      a: \"a\",\n      b: \"b\",\n      c: {\n        d: \"d\",\n        e: \"e\"\n      }\n    }\n\n    and an object of options\n    options = {\n      a: \"A\",\n      c: {\n        d: \"D\"\n        f: \"F\"\n      }\n    }\n\n    this will set defaults for any undefined values, included those\n    in nested objects:\n\n    setDefaults(options, defaultOptions) = {\n      a: \"A\",\n      b: \"b\",\n      c: {\n        d: \"D\",\n        e: \"e\",\n        f: \"F\"\n      }\n    }\n  ###\n  setDefaults: (opts, defaults) ->\n    for p of defaults\n      if (opts[p] is undefined)\n        opts[p] = defaults[p]\n      else if (typeof opts[p] is \"object\")\n        opts[p] = @setDefaults(opts[p], defaults[p]);\n    opts\n\n  ###\n    Deep-copy an object\n  ###\n  clone: (obj) ->\n    if not obj? or typeof obj isnt 'object'\n      return obj\n\n    cloneObj = new obj.constructor()\n\n    for key of obj\n      cloneObj[key] = @clone obj[key]\n\n    return cloneObj\n\n  showMessage: (message, element, callback) ->\n    oldBox.remove() for oldBox in document.getElementsByClassName(\"message-box\")\n\n    top   = element.offsetTop + 50\n    width = 280\n    left  = element.offsetLeft + (element.offsetWidth/2) - (width/2)\n\n    box = document.createElement 'div'\n    box.classList.add 'message-box'\n    box.setAttribute \"style\",\n      \"\"\"\n        top: #{top}px;\n        left: #{left}px;\n        width: #{width}px;\n      \"\"\"\n\n    box.innerHTML = message\n\n    button = document.createElement 'div'\n    button.classList.add 'button'\n    button.innerHTML = \"Ok\"\n    button.addEventListener 'click', ->\n      element.removeChild box\n      if callback then callback()\n    box.appendChild button\n\n    element.appendChild box\n\n  stringify: (obj)->\n    if not obj? or typeof obj isnt 'object'\n      return String(obj)\n\n    str = \"{ \"\n    for key of obj\n      str += String(key) + \": \" + @stringify obj[key] + \", \"\n\n    return str.slice(0,str.length-2) + \" }\"\n\n  # sources is an array of objects, each which have a 'preload' property.\n  # the 'preload' property is an array of strings which will be treated as urls.\n  # The strings can be image paths or paths to json files specifying assets\n  # ex: preload([{preload: [\"foo.jpg\", \"bar.png\"]},{preload: [\"baz.json\"]}], function() {/**all done**/})\n  preload: (sources, callback)->\n    statusContainer = document.createElement 'div'\n    statusContainer.classList.add 'preload-message'\n    statusDom = document.createElement 'div'\n    statusDom.classList.add 'text'\n    statusDom.innerHTML = \"Loading... 0% complete.\"\n    statusContainer.appendChild statusDom\n    document.body.appendChild statusContainer\n\n    assets = []\n    for source in sources\n      continue unless source.preload?\n      for asset in source.preload\n        assets.push asset\n\n    numImages = null\n\n    loader = new PIXI.AssetLoader(assets)\n\n    loader.onProgress = ->\n      if not numImages\n        numImages = loader.loadCount + 1\n      statusDom.innerHTML = \"Loading... \"+Math.floor((numImages-loader.loadCount)/numImages*100)+\"%\"\n    loader.onComplete = ->\n      statusDom.innerHTML = \"Loading complete!\"\n      setTimeout ->\n        callback()\n        document.body.removeChild statusContainer\n      , 10\n    loader.load()\n\n  mixOf: (base, mixins...) ->\n    class Mixed extends base\n    for mixin in mixins by -1 #earlier mixins override later ones\n      for name, method of mixin::\n        Mixed::[name] = method\n    Mixed\n","AgentView = require 'views/agent-view'\nhelpers   = require 'helpers'\n\ndefaultProperties =\n  'min offspring': 1\n  'max offspring': 3\n  'min offspring distance': 10\n  'max offspring distance': 40\n  'health': 1\n  'is immortal': false\n  'resource deficit': 0\n  'resource consumption rate': 1\n\n###\n  The base agent class\n###\nmodule.exports = class Agent\n  label: \"organism\"\n  bred: false\n  _viewLayer: 1\n\n  constructor: ({@name, @environment, @species, x, y, additionalDefaults}) ->\n    @_props = helpers.clone defaultProperties\n    @_props = helpers.setDefaults(@_props, additionalDefaults) if additionalDefaults?\n    @_view = new AgentView({agent: @})\n    @_viewLayer = @species.viewLayer if @species?.viewLayer?\n    if x? && y?\n      @setLocation({x,y})\n    @makeNewborn()\n\n  getView: ->\n    return @_view\n\n  setLocation: ({x, y}) ->\n    # TODO When we support movement, we'll have to check if the results changed,\n    # and if so, update the agent's movement direction\n    if @environment\n      {x,y} = @environment.ensureValidLocation({x,y})\n    @_x = x\n    @_y = y\n\n  getLocation: ->\n    {x: @_x, y: @_y}\n\n  set: (prop, value) ->\n    @_props[prop] = value\n\n  get: (prop) ->\n    if @hasProp(prop) then val = @_props[prop]\n    else val = @getEnvironmentProperty prop\n\n    if !val? then throw new Error(\"Cannot find property \"+prop)\n    return val\n\n  hasProp: (prop) ->\n    return @_props[prop]?\n\n  getAllProperties: ->\n    return @_props\n\n  getEnvironmentProperty: (prop) ->\n    return null unless @environment?\n    @environment.getAt @_x, @_y, prop\n\n  setEnvironmentProperty: (prop, val) ->\n    return unless @environment?\n    @environment.setAt @_x, @_y, prop, val\n\n  getImages: (opts = {})->\n    @species.getImages this, opts\n\n  getSize: ->\n    if @species.defs.MATURITY_AGE\n      maturity = @get('age') / @species.defs.MATURITY_AGE\n      Math.min maturity, 1\n    else\n      1\n\n  isDead: false\n\n  die: ->\n    @isDead = true\n\n  step: ->\n    @_incrementAge()\n    @_checkSurvival()\n\n  makeNewborn: ->\n    @set('age', 0)\n\n  ###\n    Creates one or more offspring, depending on the min- and max- offspring\n    properties, and places them in the environment.\n\n    Returns the array of offspring.\n\n    Only asexual for now\n  ###\n  reproduce: (mate) ->\n    minOffspring = @get 'min offspring'\n    maxOffspring = @get 'max offspring'\n    numOffspring = minOffspring + ExtMath.randomInt(1 + maxOffspring - minOffspring)\n\n    for i in [0...numOffspring]\n      @createOffspring(mate)\n\n  ###\n    Returns an offspring and places it in the environment\n\n    Only asexual reproduction for now\n  ###\n  createOffspring: (mate) ->\n    offspring = @_clone()\n    offspring._mutate()\n    offspring.makeNewborn()\n    offspring.bred = true\n\n    if @environment\n      offspring.setLocation @_findOffspringLocation()\n      @environment.addAgent offspring\n\n    return offspring\n\n  canShowInfo: ->\n    true\n\n  zIndex: (val)->\n    if val?\n      @_zIndex = val\n      return\n\n    return if @_zIndex? then @_zIndex else @_y\n\n  _clone: ->\n    clone = @species.createAgent()\n    for prop of @_props\n      clone.set prop, @_props[prop]\n    return clone\n\n  _mutate: ->\n    for trait in @species.traits\n      if trait.mutatable and Math.random() < @species.defs.CHANCE_OF_MUTATION\n        currentVal = @get trait.name\n        mutatedVal = trait.mutate currentVal\n        @set trait.name, mutatedVal\n\n  _findOffspringLocation: ->\n    loc = @getLocation()\n\n    minD = @get 'min offspring distance'\n    maxD = @get 'max offspring distance'\n\n    distance = ExtMath.randomValue minD, maxD\n    angle    = Math.random() * 2 * Math.PI\n\n    xStep = Math.floor distance * Math.sin angle\n    yStep = Math.floor distance * Math.cos angle\n\n    return {x: loc.x + xStep, y: loc.y + yStep}\n\n\n  _incrementAge: ->\n    @set('age', @get('age')+1)\n\n  _consumeResources: ->\n    food = @getEnvironmentProperty('food')\n    consumption = @get('resource consumption rate')\n    if food >= consumption\n      @setEnvironmentProperty('food', food - consumption)\n      @set('resource deficit', 0)\n    else\n      underfed = consumption - food\n      currDeficit = @get('resource deficit')\n      @set('resource deficit', currDeficit + underfed)\n      @setEnvironmentProperty('food', 0)\n\n  _checkSurvival: ->\n    chance = if @hasProp('chance of survival') then @get('chance of survival') else @_getSurvivalChances()\n    @die() if Math.random() > chance\n\n  _getSurvivalChances: ->\n    return 1.0 if @get('is immortal')\n\n    age = @get('age')\n    ageMax = @species.defs.MAX_AGE || 2000\n\n    agePct = 1 - (age/ageMax)\n\n    # TODO factor in HUNGER\n    hunger = @get 'resource deficit'\n    hungerPct = 1 - Math.pow(hunger/100, 2)\n\n    healthPct = @get('health')/@species.defs.MAX_HEALTH\n\n    return agePct * hungerPct * healthPct\n\n\n","module.exports = class AnimatedAgent\n\n  @MOVEMENTS:\n    STOPPED: \"stop\"\n    MOVESTEP: \"move-step\"\n\n  currentMovement: AnimatedAgent.MOVEMENTS.STOPPED\n\n  setMovement: (@currentMovement) ->\n    undefined\n\n  getMovement: ->\n    @currentMovement\n","Agent = require 'models/agent'\nEvents = require 'events'\nEnvironment = require 'models/environment'\nTrait = require 'models/trait'\nhelpers = require 'helpers'\n\ndefaultProperties =\n  'direction': 0\n  'speed': 1\n  'default speed': 10\n  'sex': 'female'\n  'prey': []\n  'predator': []\n  'hiding place': []\n  'chance of being seen': 1.0\n  'max energy': 100\n  'energy': 100\n  'metabolism': 3\n  'vision distance': 300\n  'eating distance': 50\n  'mating distance': 50\n  'current behavior': 'wandering'\n  'calculate drives': true\n  'hunger bonus': 0\n  'mating desire bonus': 0\n  'fear bonus': 0\n  'wandering threshold': 5\n  'bubble showing': 'none'\n\n###\n  The base class of a simple animal\n###\nmodule.exports = class BasicAnimal extends Agent\n  label: 'animal'\n  _viewLayer: 2\n  _hasEatenOnce: false\n  _timeLastMated: -20\n\n  @BEHAVIOR:\n    EATING: 'eating'\n    MATING: 'mating'\n    FLEEING: 'fleeing'\n    HIDING: 'hiding'\n    WANDERING: 'wandering'\n\n  constructor: (args) ->\n    if args.additionalDefaults?\n      defaults = helpers.setDefaults(helpers.clone(defaultProperties), args.additionalDefaults)\n    else\n      defaults = helpers.clone defaultProperties\n    args.additionalDefaults = defaults\n    super(args)\n\n  makeNewborn: ->\n    super()\n    @set 'sex', (if ExtMath.flip() is 0 then 'female' else 'male')\n    @set 'energy', @get('max energy')\n    @set 'direction', ExtMath.randomFloat(2 * Math.PI)\n    @set 'speed', @get('default speed')\n\n  step: ->\n    @_closestAgents = null\n    @_setSpeedAppropriateForAge()\n    @_depleteEnergy()\n    if @get 'calculate drives'\n      @set 'current behavior', @_determineBehavior()\n\n    switch @get('current behavior')\n      when BasicAnimal.BEHAVIOR.EATING\n        @eat()\n      when BasicAnimal.BEHAVIOR.FLEEING\n        @flee()\n      when BasicAnimal.BEHAVIOR.MATING\n        @mate()\n      when BasicAnimal.BEHAVIOR.WANDERING\n        @wander()\n      else\n        # NOOP\n\n    @_incrementAge()\n    @_checkSurvival()\n\n  eat: ->\n    nearest = @_nearestPrey()\n    if nearest?\n      eatingDist = @get('eating distance')\n      if nearest.distanceSq < Math.pow(eatingDist, 2)\n        @_eatPrey(nearest.agent)\n      else\n        @chase(nearest)\n    else\n      @wander(@get('speed') * 0.75)\n\n  flee: ->\n    nearest = @_nearestPredator()\n    if nearest?\n      hidingPlace = @_nearestHidingPlace()\n      if hidingPlace?\n        speed = @get 'speed'\n        @set 'speed', speed*6\n        @chase(hidingPlace)\n        @set 'speed', speed\n\n        @set('current behavior', BasicAnimal.BEHAVIOR.HIDING) if hidingPlace.distanceSq < Math.pow(@get('speed'), 2)\n      else\n        @runFrom(nearest)\n    else\n      @wander()\n\n  mate: ->\n    nearest = @_nearestMate()\n    if nearest?\n      @chase(nearest)\n      if nearest.distanceSq < Math.pow(@get('mating distance'), 2)\n        max = @get('max offspring')\n        @set 'max offspring', Math.max(max/2, 1)\n        @reproduce()\n        @set 'max offspring', max\n        @_timeLastMated = @environment.date\n    else\n      @wander(@get('speed') * Math.random() * 0.75)\n\n  wander: (speed)->\n    unless speed?\n      maxSpeed = @get('speed')\n      speed = (maxSpeed/2) + ExtMath.randomGaussian() * (maxSpeed/6)\n    @set 'direction', (@get('direction') + ExtMath.randomGaussian()/10)\n    @move(speed)\n\n  chase: (agentDistance)->\n    directionToAgent =  @_direction(@getLocation(), agentDistance.agent.getLocation())\n    directionRelativeToMe = ExtMath.normalizeRads(directionToAgent - this.get('direction'))\n    directionToMove = @get('direction') + directionRelativeToMe / 10\n    @set('direction', directionToMove)\n    speed = Math.min(@get('speed'), Math.sqrt(agentDistance.distanceSq))\n    @move(speed)\n\n  runFrom: (agentDistance)->\n    directionToRunTo =  @_direction(@getLocation(), agentDistance.agent.getLocation()) + Math.PI + (ExtMath.randomGaussian()/3)\n    directionToMove = (@get('direction')*19 + directionToRunTo) / 20\n    @set('direction', directionToMove)\n    @move(@get 'speed')\n\n  move: (speed) ->\n    dir = @get 'direction'\n    return if speed is 0\n    throw new Error('invalid speed') unless typeof(speed) is 'number'\n    throw new Error('invalid direction') unless typeof(dir) is 'number'\n    loc = @getLocation()\n    dx = speed * Math.cos(dir)\n    dy = speed * Math.sin(dir)\n\n    newLoc = {x: loc.x + dx, y: loc.y + dy}\n    if @environment.crossesBarrier(loc, newLoc)\n      # stay where you are and turn around, for now\n      @set 'direction', dir + Math.PI\n    else\n      @setLocation newLoc\n\n  _direction: (from, to)->\n    dx = to.x - from.x\n    dy = to.y - from.y\n\n    return ExtMath.normalizeRads(Math.atan2(dy, dx))\n\n  _eatPrey: (agent)->\n    food = agent.get('food')\n    currEnergy = @get('energy')\n    @set('energy', Math.min(@get('max energy'), currEnergy + food))\n    agent.die()\n    @_hasEatenOnce = true\n\n    Events.dispatchEvent(Environment.EVENTS.AGENT_EATEN, {predator: @, prey: agent})\n\n  _setSpeedAppropriateForAge: ->\n    age = @get 'age'\n    speed = @get 'default speed'\n    if age < 5\n      speed = 2\n    else if age < 10\n      speed = 5\n    @set 'speed', speed\n\n  _depleteEnergy: ->\n    currEnergy = @get 'energy'\n    rate = @get 'metabolism'\n    behavior = @get 'current behavior'\n    if behavior is BasicAnimal.BEHAVIOR.HIDING\n      rate = rate/2\n    @set 'energy', Math.max(0, currEnergy - rate)\n\n  _hunger: ->\n    # hunger is just directly inversely proportional to energy\n    percentEnergy = @get('energy') / @get('max energy')\n\n    # when we add the bonus, instead of the hunger line going from 0 to 100 it goes from 'bonus' to 100\n    range = 100 - @get('hunger bonus')\n\n    return 100 - (range * percentEnergy)\n\n  _fear: ->\n    if not @get('predator') instanceof String\n      nearest = @_nearestPredator()\n      if nearest?\n        vision = @get('vision distance')\n        percentCloseness = (vision - Math.sqrt(nearest.distanceSq)) / vision\n        return Math.pow(10 * percentCloseness, 2)\n\n    return 0\n\n  _desireToMate: ->\n    age = @get 'age'\n    return 0 if @species.defs.MATURITY_AGE? and age < @species.defs.MATURITY_AGE\n    return 0 if @get('max offspring') < 1\n    return 0 unless @_hasEatenOnce\n    return 0 if (@environment.date - @_timeLastMated) < 20\n\n    proximityDesire = if @_nearestMate()? then 30 else 15\n    reciprocationFactor = if @_nearestMatingMate()? then 15 else 0\n    matingBonus = @get 'mating desire bonus'\n\n    return proximityDesire + reciprocationFactor + matingBonus\n\n  _determineBehavior: ->\n    hunger = @_hunger()\n    fear = @_fear()\n    desire = @_desireToMate()\n    wanderThreshold = @get('wandering threshold')\n    if hunger < wanderThreshold and fear < wanderThreshold and desire < wanderThreshold\n      return BasicAnimal.BEHAVIOR.WANDERING\n\n    max = Math.max(Math.max(hunger, fear), desire)\n    # in case of ties, order is FLEE, EAT, MATE\n    if max == fear\n      return BasicAnimal.BEHAVIOR.FLEEING\n    else if max == hunger\n      return BasicAnimal.BEHAVIOR.EATING\n    else\n      return BasicAnimal.BEHAVIOR.MATING\n\n  _nearestPredator: ->\n    predator = @get('predator')\n    if predator? and predator.length? and predator.length > 0\n      nearest = @_nearestAgentsMatching {types: predator, quantity: 1}\n      return nearest[0] || null\n    return null\n\n  _nearestPrey: ->\n    prey = @get('prey')\n    if prey? and prey.length? and prey.length > 0\n      nearest = @_nearestAgentsMatching {types: prey}\n      return nearest[ExtMath.randomInt(nearest.length)]\n\n    return null\n\n  _nearestHidingPlace: ->\n    hidingPlace = @get('hiding place')\n    if hidingPlace? and hidingPlace.length? and hidingPlace.length > 0\n      nearest = @_nearestAgentsMatching {types: hidingPlace, quantity: 1}\n      return nearest[0] || null\n\n    return null\n\n  _nearestMate: ->\n    desiredSex = if @get('sex') is 'male' then 'female' else 'male'\n    trait = new Trait({name: 'sex', possibleValues: [desiredSex]})\n    nearest = @_nearestAgentsMatching {types: [{name: @species.speciesName, traits: [trait]}], quantity: 1}\n    return nearest[0] || null\n\n  _nearestMatingMate: ->\n    desiredSex = if @get('sex') is 'male' then 'female' else 'male'\n    trait  = new Trait({name: 'sex', possibleValues: [desiredSex]})\n    trait2 = new Trait({name: 'current behavior', possibleValues: [BasicAnimal.BEHAVIOR.MATING]})\n    nearest = @_nearestAgentsMatching {types: [{name: @species.speciesName, traits: [trait, trait2]}], quantity: 1}\n    return nearest[0] || null\n\n  _nearestAgents: ->\n    return @_closestAgents if @_closestAgents?\n    loc = @getLocation()\n    vision = @get('vision distance')\n    vision = @get('speed') * 15 unless vision?\n    visibleArea = {x: loc.x - vision, y: loc.y - vision, width: vision*2, height: vision*2}\n    visibleAgents = @environment.agentsWithin(visibleArea)\n\n    closest = []\n    for a in visibleAgents\n      closest.push new AgentDistance(a, @_distanceSquared(loc, a.getLocation()))\n\n    @_closestAgents = closest.sort (a,b)->\n      return a.distanceSq - b.distanceSq\n    return @_closestAgents\n\n  _nearestAgentsMatching: (options)->\n    opts = helpers.setDefaults options,\n      camo: true\n      quantity: 3\n      crossBarriers: false\n\n    throw new Error(\"Must pass agent types array\") unless opts.types? or typeof(opts.types) isnt 'object' or not opts.types.length?\n\n    nearest = @_nearestAgents()\n    returnedAgents = []\n    for agentDistance in nearest\n      agent = agentDistance.agent\n      for type in opts.types\n        throw new Error(\"types array must be an array of objects in format {name: 'foo', traits: []}\") if typeof(type) isnt 'object' or not type.name?\n        continue if type.name isnt agent.species.speciesName\n\n        continue if agent is @\n        continue if opts.camo and agent instanceof BasicAnimal and ExtMath.randomFloat() > agent.get('chance of being seen')\n        continue if agent.hasProp('current behavior') and agent.get('current behavior') is BasicAnimal.BEHAVIOR.HIDING\n        continue if !opts.crossBarriers and @environment.crossesBarrier(@getLocation(), agent.getLocation())\n        if type.traits? and type.traits.length > 0\n          # All traits must match to be considered a valid agent match\n          nextType = false\n          for trait in type.traits\n            nextType = true unless trait.isPossibleValue(agent.get(trait.name))\n          continue if nextType\n\n        returnedAgents.push agentDistance\n        return returnedAgents if returnedAgents.length >= opts.quantity\n\n    return returnedAgents\n\n  _distanceSquared: (p1, p2)->\n    dx = p1.x - p2.x\n    dy = p1.y - p2.y\n    return (dx*dx + dy*dy)\n\n  _getSurvivalChances: ->\n    return 1.0 if @get('is immortal')\n\n    basicPct = super()\n\n    energy = @get 'energy'\n    energyPct = 1 - Math.pow(1-(energy/100), 8)\n\n    return basicPct * energyPct\n\nclass AgentDistance\n  constructor: (@agent, @distanceSq)->\n    undefined\n\n","Agent = require 'models/agent'\nhelpers = require 'helpers'\n\ndefaultProperties =\n  'is seed': true\n  'can seed': true\n  'has flowers': false\n  'chance of flowering': 1\n\n###\n\tThe base class of a simple plant\n###\nmodule.exports = class BasicPlant extends Agent\n  label: 'plant'\n\n  _hasSeeded: false\n\n  constructor: (args) ->\n    super(args)\n    @_props = helpers.setDefaults(@_props, defaultProperties)\n\n  getSize: ->\n    age = @get('age')\n    if @species.defs.SPROUT_AGE and age < @species.defs.SPROUT_AGE\n      1\n    else if @species.defs.MATURITY_AGE\n      maturity = @get('age') / @species.defs.MATURITY_AGE\n      Math.min maturity, 1\n    else\n      1\n\n  makeNewborn: ->\n    super()\n    @set 'has flowers', false\n\n  createSeeds: ->\n    # quick addition to prevent over-popualtion. This could also be controlled\n    # by a species setting\n    if @get('num agents') > 2 then return\n\n    @reproduce()\n    @_hasSeeded = true\n    @set 'has flowers', false\n\n  step: ->\n    age     = @get 'age'\n    season  = @get 'season'\n\n    # seeds are frozen and do not start aging until spring\n    if age is 0 and season isnt \"spring\"\n      return\n\n    @_incrementAge()\n\n    if @get 'is seed'\n      if age < @species.defs.SPROUT_AGE\n        return\n      else\n        @set 'is seed', false\n\n    if (!@_hasSeeded) and @species.defs.CAN_SEED\n      if !@get('has flowers') and age > @species.defs.MATURITY_AGE and ((!@species.defs.IS_ANNUAL) || season isnt \"fall\")\n        if Math.random() < @get 'chance of flowering'\n          @set 'has flowers', true\n\n      if @get 'has flowers'\n        if @species.defs.IS_ANNUAL\n          if season is \"fall\" and Math.random() < @species.defs.CHANCE_OF_SEEDING\n            @createSeeds()\n        else\n          if Math.random() < @species.defs.CHANCE_OF_SEEDING\n            @createSeeds()\n\n    if season is 'winter' and !@get 'is immortal'\n      health = @get 'health'\n      @set 'health', health * 0.5\n\n    @_checkSurvival()\n","Agent = require 'models/agent'\nhelpers = require 'helpers'\n\ndefaultProperties =\n  'growth rate': 0.5\n  'min offspring': 1\n  'max offspring': 2\n  'max offspring distance': 150\n  'food quantity': 20\n\n###\n  The base class of a simple plant\n###\nmodule.exports = class FastPlant extends Agent\n  label: 'plant'\n\n  _hasSeeded: false\n\n  constructor: (args) ->\n    super(args)\n    # FastPlant defaults take priority over Agent defaults\n    @_props = helpers.setDefaults(helpers.clone(defaultProperties), @_props)\n\n  getSize: ->\n    1\n\n  makeNewborn: ->\n    @set('age', 10)\n    @set('chance of survival', 1.0)\n    @set('resource deficit', 0)\n\n  step: ->\n    food = @getEnvironmentProperty 'food'\n    if food > 0\n      if ExtMath.randomFloat(1) < @get 'growth rate'\n        @reproduce()\n\n    @_checkSurvival()\n\n  _checkSurvival: ->\n    chance = @get('chance of survival')\n    if ExtMath.randomFloat(1) > chance\n      @die()\n","EnvironmentView = require 'views/environment-view'\nStateMachine = require 'state-machine'\nhelpers = require \"helpers\"\nEvents = require 'events'\n\nSEASONS = [\"spring\", \"summer\", \"fall\", \"winter\"]\n\ndefaultOptions =\n #columns         :   # not defined because it may conflict with width\n #rows            :\n #width           :   # not defined because it may conflict with columns\n #height          :\n  imgPath         : \"\"\n  winterImgPath   : null\n  barriers        : []\n  wrapEastWest    : false\n  wrapNorthSouth  : false\n  seasonLengths   : []      # optionally the lengths of [spring, summer, fall, winter]\n  depthPerception : false   # sort agents so that agents on the bottom are drawn on top of agents on the top\n\ncellDefaults =\n  'food'               : 100\n  'food animals'       : 100\n  'food full'          : 100\n  'food low'           :  30\n  'food regrowth rate' :   3\n\n#Other options also accessible by @get\n# season          :   # set by seasonsLength\n# yearLength      :   # set by seasonsLength\n\nmodule.exports = class Environment extends StateMachine\n  @DEFAULT_RUN_LOOP_DELAY: 54.5\n\n  constructor: (opts) ->\n    opts = helpers.setDefaults(opts, defaultOptions)\n    @[prop] = opts[prop] for prop of opts     # give us immediate access to @columns, @barriers, etc\n\n    @preload = []\n    @preload.push @imgPath if @imgPath?\n    @preload.push @winterImgPath if @winterImgPath\n\n    if @columns and @width\n      throw new Error(\"You can set columns and rows, or width and height, but not both\")\n    if @columns\n      @width = @columns * @_columnWidth\n      @height = @rows * @_rowHeight\n    if @width\n      if not (@width % @_columnWidth == 0)\n        throw new Error(\"Width #{@width} is not evenly divisible by the column width #{@_columnWidth}\")\n      if not (@height % @_rowHeight == 0)\n        throw new Error(\"Height #{@height} is not evenly divisible by the row height #{@_rowHeight}\")\n      @columns = @width / @_columnWidth\n      @rows = @height / @_rowHeight\n\n    @cells = []\n    @cells[col] = [] for col in [0..@columns]\n    @_setCellDefaults()\n\n    @_runLoopDelay = Environment.DEFAULT_RUN_LOOP_DELAY\n\n    @setBarriers(@barriers)\n\n    @agents = []\n    @_rules = []\n\n    @carriedAgent = null\n\n    @_remapSeasonLengths()\n\n    @season = SEASONS[0]\n    @date   = 0\n\n    # Add User Interaction states\n    @addState @UI_STATE.NONE, EmptyState\n    @addState @UI_STATE.ADD_AGENTS, AddAgentsState\n\n    @_view = new EnvironmentView({environment: @})\n\n    @setState @UI_STATE.NONE\n\n  ### Public API ###\n\n  addAgent: (agent)->\n    agent.environment = this\n    loc = @ensureValidLocation agent.getLocation()\n    agent.setLocation loc\n    if @isInBarrier loc.x, loc.y\n      return false\n\n    col = Math.floor loc.x / @_columnWidth\n    row = Math.floor loc.y / @_rowHeight\n    agents = @get col, row, \"num agents\"\n    if !agents?\n      @set col, row, \"num agents\", 1\n    else\n      @set col, row, \"num agents\", agents+1\n\n    unless @agents.indexOf(agent) != -1\n      @agents.push(agent)\n      Events.dispatchEvent(Environment.EVENTS.AGENT_ADDED, {agent: agent})\n      return true\n    return false\n\n  removeAgent: (agent)->\n    loc = agent.getLocation()\n    col = Math.floor loc.x / @_columnWidth\n    row = Math.floor loc.y / @_rowHeight\n    agents = @get col, row, \"num agents\"\n    if !agents?\n      @set col, row, \"num agents\", 0\n    else\n      @set col, row, \"num agents\", agents-1\n\n    @getView().removeAgent(agent) if @agents.removeObj(agent)\n\n  removeDeadAgents: ->\n    i = 0\n    while i < @agents.length\n      a = @agents[i]\n      if a.isDead\n        @removeAgent(a)\n      else\n        i++\n\n  agentsWithin: ({x,y,width,height})->\n    throw new Error(\"Invalid rectangle definition!\") unless x? and y? and width? and height?\n    area = new Barrier(x,y,width,height)\n    found = []\n    for agent in @agents\n      loc = agent.getLocation()\n      found.push agent if area.contains(loc.x, loc.y)\n\n    return found\n\n  ensureValidLocation: ({x,y}) ->\n    x = if @wrapEastWest   then @_wrapSingleDimension(x,  @width) else @_bounceSingleDimension(x,  @width)\n    y = if @wrapNorthSouth then @_wrapSingleDimension(y, @height) else @_bounceSingleDimension(y, @height)\n\n    return {x,y}\n\n  randomLocation: ->\n    return @randomLocationWithin(0,0,@width,@height)\n\n  randomLocationWithin: (left, top, width, height, avoidBarriers=false)->\n    point = {x: ExtMath.randomInt(width)+left, y: ExtMath.randomInt(height)+top}\n    while avoidBarriers and @isInBarrier(point)\n      point = {x: ExtMath.randomInt(width)+left, y: ExtMath.randomInt(height)+top}\n    return point\n\n  set: (col, row, prop, val) ->\n    if not @cells[col][row]\n      @cells[col][row] = {}\n\n    @cells[col][row][prop] = val\n\n  get: (col, row, prop) ->\n    # get global properties first\n    if @[prop]?\n      return @[prop]\n    if not @cells[col][row]\n      return null\n\n    return @cells[col][row][prop]\n\n  getAt: (x, y, prop) ->\n    col = Math.floor x / @_columnWidth\n    row = Math.floor y / @_rowHeight\n    return @get(col, row, prop)\n\n  setAt: (x, y, prop, val) ->\n    col = Math.floor x / @_columnWidth\n    row = Math.floor y / @_rowHeight\n    return @set(col, row, prop, val)\n\n  getAgentsAt: (x,y)->\n    agents = []\n    for agent in @agents\n      if agent.getView().contains(x,y)\n        agents.push agent\n    return agents\n\n  getAgentAt: (x,y)->\n    for agent in @agents\n      if agent.getView().contains(x,y)\n        return agent\n    return null\n\n  getAgentsCloseTo: (x, y, maxDistance=10, speciesName)->\n    area = {x: x - maxDistance, y: y - maxDistance, width: maxDistance*2, height: maxDistance*2}\n    agents = @agentsWithin(area)\n    return [] unless agents.length\n    if speciesName\n      _agents = []\n      for agent in agents\n        if agent.species.speciesName is speciesName then _agents.push agent\n      agents = _agents\n    return agents\n\n  getAgentCloseTo: (x, y, maxDistance=10, speciesName)->\n    agents = @getAgentsCloseTo(x, y, maxDistance, speciesName)\n    return null unless agents.length\n    for agent in agents\n      agent.__distance = ExtMath.distanceSquared agent.getLocation(), {x, y}\n    agents = agents.sort (a,b)->\n      return a.__distance - b.__distance\n    return agents[0]\n\n  setBarriers: (bars)->\n    barriers = bars.slice()\n    @barriers = []\n    for barrier in (barriers || [])\n      @addBarrier.apply this, barrier\n    @_view.rerenderBarriers() if @_view && @_view.barrierGraphics?\n\n  addBarrier: (x, y, width, height) ->\n    @barriers.push new Barrier x, y, width, height\n\n  crossesBarrier: (start, finish)->\n    if (!@wrapEastWest && (0 > finish.x || finish.x > @width)) ||\n        (!@wrapNorthSouth && (0 > finish.y || finish.y > @height))\n      return true\n\n    dx = finish.x - start.x\n    dy = finish.y - start.y\n    if dx isnt 0\n      m = dy/dx\n      line = (x,y)->\n        return m * (x - start.x) + start.y - y\n    else\n      line = (x,y)->\n        return x - start.x\n    for barrier in @barriers\n      return true if barrier.contains(finish.x, finish.y)\n      continue if (start.x > barrier.x2 and finish.x > barrier.x2) or # entirely to the right\n                  (start.x < barrier.x1 and finish.x < barrier.x1) or # entirely to the left\n                  (start.y > barrier.y2 and finish.y > barrier.y2) or # entirely below\n                  (start.y < barrier.y1 and finish.y < barrier.y1)    # entirely above\n      return true if barrier.intersectsLine(line)\n    return false\n\n  setSeasonLength: (season, length)->\n    idx = -1\n    switch season\n      when \"spring\",0 then idx = 0\n      when \"summer\",1 then idx = 1\n      when \"fall\",2 then idx = 2\n      when \"winter\",3 then idx = 3\n      else throw new Error(\"Invalid season '\" + season + \"'\")\n\n    @seasonLengths[idx] = length\n    @_remapSeasonLengths()\n\n  isInBarrier: (x, y) ->\n    for barrier in @barriers\n      if barrier.contains x, y\n        return true\n    return false\n\n  pickUpAgent: (agent) ->\n    @removeAgent(agent)\n    @carriedAgent = agent\n\n  dropCarriedAgent: ->\n    unless @addAgent(@carriedAgent)\n      # drop the agent back on it's original location if addAgent returns false\n      @carriedAgent.setLocation @_agentOrigin\n      @addAgent(@carriedAgent)\n    @getView().removeCarriedAgent(@carriedAgent)\n    @carriedAgent = null\n\n  # Used for setting the default species and traits for\n  # creating and adding agents.\n  setDefaultAgentCreator: (@defaultSpecies, @defaultTraits, @agentAdderCallback) ->\n    undefined\n\n  addDefaultAgent: (x, y) ->\n    return unless @defaultSpecies?\n    agent = @defaultSpecies.createAgent(@defaultTraits)\n    agent.environment = @\n    agent.setLocation x: x, y: y\n    success = @addAgent agent\n    if success and @agentAdderCallback then @agentAdderCallback()\n\n  ### Run Loop ###\n\n  # Speed is a value between 0 and 100, 0 being slow and 100 being fast.\n  # The default is 50.\n  setSpeed: (speed)->\n    @_speed = speed\n    # fps curve that looks like this:\n    # http://fooplot.com/#W3sidHlwZSI6MCwiZXEiOiIoLTEvKCh4LTE0MSkvNDAwMCkpLTI3LjMiLCJjb2xvciI6IiMwMDAwMDAifSx7InR5cGUiOjEwMDAsIndpbmRvdyI6WyIwIiwiMTAwIiwiMCIsIjgwIl19XQ--\n    fps = (-1/((speed-141)/4000))-27.3\n    delay = 1000/fps\n    @_runLoopDelay = delay\n\n  start: ->\n    @_isRunning = true\n    runloop = =>\n      setTimeout =>\n        @step()\n        runloop() if @_isRunning\n      , @_runLoopDelay\n\n    runloop()\n    Events.dispatchEvent(Environment.EVENTS.START, {})\n\n  stop: ->\n    @_isRunning = false\n    Events.dispatchEvent(Environment.EVENTS.STOP, {})\n\n  step: ->\n    @_incrementDate()\n    # Apply all of the rules\n    for r in @_rules\n      for a in @agents\n        r.execute(a)\n    for a in @agents\n      a._consumeResources() if a._consumeResources?\n      a.step()\n    @_replenishResources()\n    @removeDeadAgents()\n    Events.dispatchEvent(Environment.EVENTS.STEP, {})\n\n  reset: ->\n    @stop()\n    i = @agents.length\n    @removeAgent @agents[--i] while i\n    @date   = 0\n    Events.dispatchEvent(Environment.EVENTS.RESET, {})\n\n  ### Default properties ###\n\n  _columnWidth: 10\n  _rowHeight:   10\n  _rules: null\n  _speed: 50\n  _runLoopDelay: 54.5\n\n  _isRunning: false\n\n  ### Getters and Setters ###\n\n  getView: ->\n    return @_view\n\n  addRule: (rule)->\n    @_rules ||= []\n    @_rules.push(rule) unless @_rules.indexOf(rule) != -1\n\n  removeRule: (rule)->\n    @_rules ||= []\n    @_rules.removeObj rule\n\n  clearRules: ->\n    @_rules = []\n\n  setBackground: (path)->\n    @imgPath = path\n    @_view.updateBackground()\n\n  _incrementDate: ->\n    @date++\n    if @usingSeasons and @_totalSeasonLengths.length == 4\n      yearDate = @date % @yearLength\n      for length, i in @_totalSeasonLengths\n        if yearDate < length\n          if @season isnt SEASONS[i]\n            @season = SEASONS[i]\n            Events.dispatchEvent(Environment.EVENTS.SEASON_CHANGED, {season: @season})\n          break\n\n      if yearDate == @_totalSeasonLengths[2] # first day of winter\n        @_view.addWinterImage()\n      else if yearDate == @_totalSeasonLengths[3]-1 # last day of winter\n        @_view.removeWinterImage()\n\n  _replenishResources: ->\n    for x in [0..@columns]\n      for y in [0..@rows]\n        cell = @cells[x][y]\n        growthRate = cell['food regrowth rate']\n        max = cell['food full']\n        food = cell['food']\n        if food < max\n          cell['food'] = Math.min(max, food+growthRate)\n\n        food = cell['food animals']\n        if food < max\n          cell['food animals'] = Math.min(max, food+growthRate)\n\n  _wrapSingleDimension: (p, max) ->\n    if p < 0\n      p = max + p\n    else if p >= max\n      p = p - max\n    return p\n\n  _bounceSingleDimension: (p, max) ->\n    if p < 0\n      p = p * -1\n    else if p >= max\n      p = max - (p - max) - 1\n    return p\n\n  _remapSeasonLengths: ->\n    # re-map seasonLenths into end-dates for efficient access later\n    @_totalSeasonLengths = []\n    @_totalSeasonLengths[i] = length + (@_totalSeasonLengths[i-1] || 0) for length, i in @seasonLengths\n\n    @usingSeasons = @_totalSeasonLengths.length > 0\n\n    @yearLength = @_totalSeasonLengths[3] || 0\n\n  _setCellDefaults: ->\n    for x in [0..@columns]\n      for y in [0..@rows]\n        @cells[x][y] = helpers.clone cellDefaults\n\n  ### Events ###\n  @EVENTS:\n    START:  \"environment-start\"\n    STOP:   \"environment-stop\"\n    STEP:   \"environment-step\"\n    RESET:  \"environment-reset\"\n    AGENT_ADDED: \"agent-added\"\n    AGENT_EATEN: \"agent-eaten\"\n    SEASON_CHANGED: \"season-changed\"\n    USER_REMOVED_AGENTS: 'user-removed-agents'\n\n  ### UI States ###\n\n  UI_STATE:\n    NONE: \"None\"\n    ADD_AGENTS: \"Add Agents\"\n\nclass Barrier\n  constructor: (@x1, @y1, width, height) ->\n    @x2 = @x1 + width\n    @y2 = @y1 + height\n    @corners = []\n    @corners.push {x: @x1, y: @y1}\n    @corners.push {x: @x1, y: @y2}\n    @corners.push {x: @x2, y: @y1}\n    @corners.push {x: @x2, y: @y2}\n\n  contains: (x, y) ->\n    @x2 >= x >= @x1 and @y2 >= y >= @y1\n\n  # check if we intersect. see: http://stackoverflow.com/questions/3590308/testing-if-a-line-has-a-point-within-a-triangle\n  # tl;dr - by plugging in the corner points of the rectangle into the equation that describes the line from start to finish,\n  # we can determine if all of the points lie on the same side of the line. If so, the path doesn't cross the barrier.\n  # lineFunc should accept two params, x and y and return a number where negative indicates one side of the line,\n  # positive indicates the other, with 0 indicating the point lies on the line. function(x,y) {...}\n  intersectsLine: (lineFunc)->\n    previousSign = null\n    for corner in @corners\n      number = lineFunc(corner.x, corner.y)\n      return true if number is 0\n      sign = if number < 0 then -1 else 1\n      if not previousSign?\n        previousSign = sign\n      else if sign isnt previousSign\n        return true\n    return false\n\n###\n      *** User Interaction States ***\n###\n\nEmptyState =\n  enter: ->\n    @_view.setCursor \"default-cursor\"\n\nAddAgentsState =\n  enter: ->\n    @_view.setCursor \"add-agents\"\n  click: (evt) ->\n    @addDefaultAgent evt.envX, evt.envY\n\n## more states added by ui/tool-button\n","Agent = require 'models/agent'\n\n###\n  The base class of an inanimate object\n###\nmodule.exports = class Inanimate extends Agent\n  label: \"inanimate\"\n  _viewLayer: 0\n  step: ->\n    undefined\n\n  _consumeResources: null\n","module.exports = class Rule\n\n  # test: a function that returns true if the rule applies, and false otherwise, Will be passed an Agent\n  #       if test is not defined, rule is always executed\n  # action: a function that will be called if test returns true. Will be passed an Agent.\n  constructor: ({test, action}) ->\n    throw new Error(\"action is not a function!\") unless action? and typeof(action) is 'function'\n    @_test = test\n    @_action = action\n\n  execute: (agent)->\n    try\n      @_action(agent) if !@_test? || @_test(agent)\n    catch e\n      console.log(\"Error executing rule!\" + e)\n","helpers   = require 'helpers'\n\ndefaultDefs =\n  MAX_AGE: 1000\n  MAX_HEALTH: 1\n  CHANCE_OF_MUTATION: 0.2\n\nmodule.exports = class Species\n\n  # coffeelint: disable=indentation\n  constructor: ({\n      @speciesName\n      @individualName\n      @agentClass\n      @traits\n      @viewLayer\n      @imageProperties\n      @imageRules\n      @defs\n      @reproductiveStrategy\n      @mutationChance}) ->\n    @defs = helpers.setDefaults(@defs || {}, defaultDefs)\n    @_parsePreloads()\n  # coffeelint: enable=indentation\n\n  ###\n    Create an agent of this species, with the traits defined in\n    the species. Optionally, add a second set of trait definitions.\n  ###\n  createAgent: (extraTraits=[]) ->\n    agent = new @agentClass {species: this}\n\n    for trait in @traits\n      agent.set trait.name, trait.getDefaultValue()\n    for trait in extraTraits\n      agent.set trait.name, trait.getDefaultValue()\n\n    return agent\n\n  ###\n    opts.buttonImage (default = false)\n  ###\n  getImages: (agent, opts = {}) ->\n    images = []\n    for layer in @imageRules\n      continue unless @_contextMatches(opts.context, layer.contexts)\n\n      layer.selectedImage = null\n      for imageRule in layer.rules\n        if not imageRule.useIf? or imageRule.useIf.call @, agent\n          layer.selectedImage = imageRule.image\n          break\n      images.push layer if layer.selectedImage?\n\n    return images\n\n  getTrait: (traitName) ->\n    for trait in @traits\n      return trait if trait.name is traitName\n    return null\n\n  addTrait: (trait) ->\n    @traits.push trait\n\n  setMutatable: (traitName, mutatable) ->\n    trait = @getTrait traitName\n    if trait?\n      trait.mutatable = mutatable\n\n  _contextMatches: (context, validContexts)->\n    return true unless context?  # assume no context info means all contexts valid\n    return true unless validContexts? and validContexts.length > 0  # if no valid contexts are supplied, assume all contexts valid\n\n    return validContexts.indexOf(context) isnt -1\n\n  _parsePreloads: ->\n    @preload = []\n    return unless @imageRules?\n    for layer in @imageRules\n      continue unless layer.rules?\n      for imageRule in layer.rules\n        @preload.push imageRule.image.path if imageRule.image?.path?\n        continue unless imageRule.image?.animations?\n        for animation in imageRule.image.animations\n          @preload.push animation.path if animation.path?\n","###\n  A Trait is a property of a species, and all traits have a set of possible values.\n  Each agent in a species has a specific value for each of these traits. This set\n  is the agent's properties.\n\n  For example, the species Plant might have the traits\n    \"health\": 0-1\n    \"number of leaves\": 0, 2, 4\n    \"leaf color\": [\"green\", \"red\"]\n\n  and an individual plant agent might have the properties\n    \"health\": 0.9\n    \"number of leaves\": 2\n    \"leaf color\": \"green\"\n\n  The Trait class defines the allowed values for each trait and has helper methods for\n  picking random values and mutating a value.\n###\n\nrequire 'helpers'\n\nmodule.exports = class Trait\n\n  constructor: ({@name, @possibleValues, @min, @max, @default, @float, @mutatable}) ->\n    undefined\n\n  getDefaultValue: ->\n    if @default? then @default\n    else @getRandomValue()\n\n  getRandomValue: ->\n    if (@possibleValues)\n      @possibleValues.randomElement()\n    else\n      if @float\n        ExtMath.randomValue @min, @max\n      else\n        Math.floor ExtMath.randomValue @min, @max+1\n\n  mutate: (val) ->\n    return val unless @mutatable\n    if (@possibleValues and @possibleValues.length > 1)\n      loop              # silly coffeescript do-while\n        newVal = @getRandomValue()\n        break if newVal isnt val\n      return newVal\n    else if @max\n      return @_mutateValueFromRange(val)\n    else\n      return val\n\n  isPossibleValue: (val)->\n    return @possibleValues.indexOf(val) != -1\n\n  _mutateValueFromRange: (val) ->\n    sign = if ExtMath.flip() then 1 else -1\n    diff  = if @float then 0.1 else 1\n    val += (diff * sign)\n\n    val = Math.max val, @min\n    val = Math.min val, @max\n\n    return val\n\n","###\n  This is a simple implementation of a state machine, which allows\n  transitioning to named states and delegation of events to the\n  current state.\n###\n\nmodule.exports = class StateMachine\n\n  _states: null\n\n  ###\n    Add a named state with a set of event handlers.\n\n    e.g.\n      addState \"addingAgents\",\n        enter: ->\n          console.log \"We are now in 'Adding Agents' mode!\"\n        click: (evt) ->\n          addAgentAt evt.x, evt.y\n        rightClick: (evt) ->\n          removeAgent evt.x, evt.y\n  ###\n  addState: (name, state) ->\n    if !@_states? then @_states = []\n\n    @_states[name] = state\n\n  setState: (currentState) ->\n    if !@_states[currentState]?\n      throw new Error(\"No such state: #{currentState}\")\n\n    @currentState = currentState\n    if @_states[@currentState].enter?\n      @_states[@currentState].enter.apply @\n\n  send: (evtName, evt) ->\n    if !@currentState?\n      throw new Error(\"No current state exists to handle '#{evtName}'\")\n\n    if @_states[@currentState][evtName]?\n      @_states[@currentState][evtName].apply @, [evt]\n    # oddly, touch quit generating 'click' events, so here's a workaround for it\n    else if evtName is \"touchstart\" and @_states[@currentState]['click']?\n      evt.preventDefault()\n      @_states[@currentState]['click'].apply @, [evt]\n","module.exports = class AddOrganismButton\n\n  constructor: (@environment, @toolbar, {@species, @traits, @scatter, @limit, @imagePath, @showRemoveButton}) ->\n    if !@scatter\n      @toolbar.registerModalButton this\n\n  render: ->\n    @button = document.createElement 'div'\n    @button.classList.add 'button'\n    @button.classList.add 'has-no-button' if @showRemoveButton\n    @button.addEventListener 'click', => @action()\n    if !@scatter then @button.classList.add 'modal'\n\n    image = document.createElement 'img'\n    image.setAttribute 'src', @imagePath\n    @button.appendChild image\n\n    return @button\n\n  getView: -> @button\n\n  _count: 0\n  _disabled: false\n\n  disable: ->\n    @_disabled = true\n    @button.classList.add 'disabled'\n\n  reset: ->\n    @_count = 0\n    @_disabled = false\n    @button.classList.remove 'disabled'\n\n  action: ->\n    return if @_disabled\n    if @scatter\n      @scatterOrganisms()\n    else\n      @enterAddOrganismsMode()\n\n  scatterOrganisms: ->\n    for i in [0...@scatter]\n      if @limit and ++@_count >= @limit\n        @disable()\n        return if @_count > @limit\n\n      agent = @species.createAgent(@traits)\n      agent.environment = @environment\n      agent.setLocation @environment.randomLocation()\n\n      while !@environment.addAgent(agent)\n        agent.setLocation @environment.randomLocation()\n\n  enterAddOrganismsMode: ->\n    @toolbar.activateModalButton this\n    @environment.setDefaultAgentCreator @species, @traits, =>\n      if @limit and ++@_count >= @limit\n        @environment.setDefaultAgentCreator null\n        @environment.setState @environment.UI_STATE.NONE\n        @disable()\n\n    @environment.setState @environment.UI_STATE.ADD_AGENTS\n","module.exports = class InfoView\n  @_instances: []\n  @instances: ->\n    return InfoView._instances\n\n  constructor: ({@agent})->\n    InfoView._instances.push @\n\n  view: null\n  setAgent: (@agent)->\n    while @_container.children.length > 0\n      @_container.removeChild @_container.children[0]\n    @agent.getView().render(@_container, 'info-tool')\n    @_repositionAgent()\n    @_rescaleAgent()\n\n    if @_details.firstChild?\n      @_details.replaceChild @agent.getView().textView(), @_details.firstChild\n    else\n      @_details.appendChild @agent.getView().textView()\n\n    @title.innerHTML = @agent.label.charAt(0).toUpperCase() + @agent.label.slice(1)\n\n  _repositionAgent: ->\n    @_container.children[0].position = { x: 0, y: 0 }\n    @_container.position = { x: 52, y: 70 }\n\n  _rescaleAgent: ->\n    if @agent.species.defs.INFO_VIEW_SCALE?\n      @_container.scale.x = @agent.species.defs.INFO_VIEW_SCALE\n      @_container.scale.y = @agent.species.defs.INFO_VIEW_SCALE\n    else\n      @_container.scale.x = 1.25\n      @_container.scale.y = 1.25\n\n  _redraw: ->\n    if @_showing then requestAnimFrame => @_redraw()\n    @_renderer.render @_stage\n\n  render: ->\n    @view = document.createElement 'div'\n    @view.classList.add 'bubble'\n\n    if @agent._x < @agent.environment.width/2 then @view.classList.add('left') else @view.classList.add('right')\n    if @agent._y < @agent.environment.height/2 then @view.classList.add('top') else @view.classList.add('bottom')\n\n    titleBar = document.createElement 'div'\n    titleBar.classList.add 'title-bar'\n\n    @title = document.createElement 'span'\n    @title.classList.add 'title'\n    @title.innerHTML = @agent.label.charAt(0).toUpperCase() + @agent.label.slice(1)\n\n    closeButton = document.createElement 'span'\n    closeButton.classList.add 'close'\n    closeButton.innerHTML = \"<i class='fa fa-times-circle-o'></i>\"\n    closeButton.addEventListener 'click', =>\n      @hide()\n\n    content = document.createElement 'div'\n    content.classList.add 'content'\n\n    @_details = document.createElement 'div'\n    @_details.classList.add 'details'\n\n    agentView = document.createElement 'div'\n    agentView.classList.add 'agent'\n    @_stage = new PIXI.Stage(0xFFFFFF, true)\n    @_renderer = new PIXI.CanvasRenderer(125, 160)\n    @_container = new PIXI.DisplayObjectContainer()\n    @_stage.addChild @_container\n    @setAgent @agent\n    @_redraw()\n    agentView.appendChild @_renderer.view\n\n    titleBar.appendChild @title\n    titleBar.appendChild closeButton\n\n    content.appendChild agentView\n    content.appendChild @_details\n\n    @view.appendChild titleBar\n    @view.appendChild content\n\n    return @view\n\n  hide: ->\n    @view.classList.add 'hidden' unless @view.classList.contains 'hidden'\n    @_showing = false\n\n  show: ->\n    @view.classList.remove 'hidden'\n    @_showing = true\n    @_redraw()\n\n  repaint: ->\n    @_renderer.render @_stage\n","helpers = require \"helpers\"\nToolbar = require \"ui/toolbar\"\nInfoView = require \"ui/info-view\"\nSpeedSlider = require \"ui/speed-slider\"\nEvents = require 'events'\nEnvironment = require 'models/environment'\n\ndefaultOptions =\n  environment : null\n  playButton  : true\n  resetButton : true\n  speedSlider : false\n  addOrganismButtons  : []\n  toolButtons: []\n\nmodule.exports = class Interactive\n\n  constructor: (options) ->\n    @_opts = helpers.setDefaults(options, defaultOptions)\n    @environment = @_opts.environment\n    @addOrganismButtons = @_opts.addOrganismButtons\n    @toolButtons = @_opts.toolButtons\n    if Shutterbug?\n      window.shutterbug = new Shutterbug(\"body\")\n\n      # When Shutterbug wants to take a snapshot of the page, it first emits a 'shutterbug-\n      # saycheese' event. By default, any WebGL canvas will return a blank image when Shutterbug\n      # calls .toDataURL on it, However, if we ask Pixi to render to the canvas during the\n      # Shutterbug event loop (remember synthetic events such as 'shutterbug-saycheese' are\n      # handled synchronously) the rendered image will still be in the WebGL drawing buffer where\n      # Shutterbug can see it.\n      $(window).on 'shutterbug-saycheese', =>\n        @repaint()\n    if iframePhone?\n      phone = iframePhone.getIFrameEndpoint()\n      ignoreEvent = false\n      phone.addListener 'stop', =>\n        ignoreEvent = true\n        @stop()\n        ignoreEvent = false\n      phone.addListener 'play', =>\n        ignoreEvent = true\n        @play()\n        ignoreEvent = false\n      phone.addListener 'reset', =>\n        ignoreEvent = true\n        @reset()\n        ignoreEvent = false\n      Events.addEventListener Environment.EVENTS.START, ->\n        phone.post({type: 'play'}) unless ignoreEvent\n      Events.addEventListener Environment.EVENTS.STOP, ->\n        phone.post({type: 'stop'}) unless ignoreEvent\n      Events.addEventListener Environment.EVENTS.RESET, ->\n        phone.post({type: 'reset'}) unless ignoreEvent\n      phone.initialize()\n\n  getEnvironmentPane: ->\n    @view = document.createElement 'div'\n\n    @view.setAttribute \"style\", \"height: #{@environment.height}px;\"\n\n    if @_opts.speedSlider\n      speedSlider = new SpeedSlider(@environment)\n      @view.appendChild speedSlider.getView()\n\n    @view.appendChild @environment.getView().render()\n\n    @toolbar = new Toolbar(this)\n    @view.appendChild @toolbar.getView()\n\n    return @view\n\n  showPlayButton: -> @_opts.playButton\n  showResetButton: -> @_opts.resetButton\n\n  repaint: ->\n    for view in InfoView.instances()\n      view.repaint()\n    @environment.getView().repaint()\n\n  play: ->\n    @toolbar.toggleButtons['play'].click() unless @environment._isRunning\n\n  stop: ->\n    @toolbar.toggleButtons['pause'].click() if @environment._isRunning\n\n  reset: ->\n    @toolbar.toggleButtons['reset'].click()\n\nwindow.onerror = (msg, url, line)->\n  message = \"<div>There was an error in the model!<br/><pre>\" + msg + \"</pre></div>\"\n  message += \"<div>source: \" + url + \", line: \" + line + \"</div>\"\n  helpers.showMessage message, document.body\n","# Based on the code here: http://jsfiddle.net/LucP/BPdKR/2/\n# TODO We could probably convert this to not rely on jQuery...\n# coffeelint: disable=no_backticks\n\n`\nvar PPSliderClass;\n(function ($) {\n\n  PPSliderClass = function (el, opts) {\n    var startMouse, lastElemPos;\n\n    if (typeof($) == 'undefined' || $ == null) {\n      console.warn('jQuery not loaded! PPSlider is not supported');\n      return;\n    }\n    var element = $(el);\n    var options = opts;\n    var isMouseDown = false;\n    var currentVal = 0;\n\n    element.wrap('<div/>')\n    var container = $(el).parent();\n\n    container.addClass('pp-slider');\n    if (opts.vertical) {\n      container.addClass('vertical');\n    }\n    container.addClass('clearfix');\n    var minLabel = '<div class=\"pp-slider-min\">' + opts.minLabel + '</div>';\n    var maxLabel = '<div class=\"pp-slider-max\">' + opts.maxLabel + '</div>';\n    var content = '';\n    if (opts.vertical) {\n      content  += maxLabel;\n    } else {\n      content  += minLabel;\n    }\n    content    += '<div class=\"pp-slider-scale\">';\n    content    += '<div class=\"pp-slider-button';\n    if (options.moveable) {\n      content  += ' moveable';\n    }\n    content    += '\"><div class=\"pp-slider-divies\"></div></div>';\n    content    += '<div class=\"pp-slider-tooltip\"></div>';\n    content    += '</div>';\n    if (opts.vertical) {\n      content  += minLabel;\n    } else {\n      content  += maxLabel;\n    }\n    container.append(content);\n\n    if (typeof(options) != 'undefined' && typeof(options.hideTooltip) != 'undefined' && options.hideTooltip == true)\n    {\n      container.find('.pp-slider-tooltip').hide();\n      container.addClass('noTooltip');\n    }\n\n    if (typeof(options.width) != 'undefined')\n    {\n      container.css('width',(options.width+'px'));\n    }\n    if (typeof(options.height) != 'undefined')\n    {\n      container.css('height',(options.height+'px'));\n    }\n    if (opts.vertical) {\n      container.find('.pp-slider-scale').css('height',(container.height()-30)+'px');\n    } else {\n      container.find('.pp-slider-scale').css('width',(container.width()-30)+'px');\n    }\n\n    var startSlide = function (e) {\n      if (!options.moveable) {\n        return true;\n      }\n      if (e.originalEvent && e.originalEvent instanceof TouchEvent) {\n        e.preventDefault();\n      }\n      isMouseDown = true;\n      var pos = getMousePosition(e);\n      if (options.vertical) {\n        startMouse = pos.y;\n        lastElemPos = ($(this).offset().top - $(this).parent().offset().top);\n      } else {\n        startMouse = pos.x;\n        lastElemPos = ($(this).offset().left - $(this).parent().offset().left);\n      }\n\n      updatePosition(e);\n\n      return false;\n    };\n\n    var getMousePosition = function (e) {\n      var posx = 0;\n      var posy = 0;\n\n      if (!e) var e = window.event;\n\n      if (e.originalEvent && e.originalEvent  instanceof TouchEvent) {\n        posx = e.originalEvent.changedTouches[0].pageX;\n        posy = e.originalEvent.changedTouches[0].pageY;\n      }\n      else if (e.pageX || e.pageY) {\n        posx = e.pageX;\n        posy = e.pageY;\n      }\n      else if (e.clientX || e.clientY) {\n        posx = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;\n        posy = e.clientY + document.body.scrollTop  + document.documentElement.scrollTop;\n      }\n\n      return { 'x': posx, 'y': posy };\n    };\n\n    var positionSlider = function(newPos, currentVal) {\n      if (options.vertical) {\n        container.find('.pp-slider-button').css(\"top\", newPos);\n        container.find('.pp-slider-tooltip').html(currentVal+'%');\n        container.find('.pp-slider-tooltip').css('top', newPos-6);\n      } else {\n        container.find('.pp-slider-button').css(\"left\", newPos);\n        container.find('.pp-slider-tooltip').html(currentVal+'%');\n        container.find('.pp-slider-tooltip').css('left', newPos-6);\n      }\n    };\n\n    var updatePosition = function (e) {\n      var pos = getMousePosition(e);\n      var newPos, upperBound;\n      if (options.vertical) {\n        var spanY = (pos.y - startMouse);\n        newPos = (lastElemPos + spanY)\n        upperBound = (container.find('.pp-slider-scale').height()-container.find('.pp-slider-button').height());\n      } else {\n        var spanX = (pos.x - startMouse);\n        newPos = (lastElemPos + spanX)\n        upperBound = (container.find('.pp-slider-scale').width()-container.find('.pp-slider-button').width());\n      }\n      newPos = Math.max(0,newPos);\n      newPos = Math.min(newPos,upperBound);\n      currentVal = Math.round((newPos/upperBound)*100,0);\n      if (options.vertical) {\n        // inverted when vertical\n        currentVal = 100 - currentVal;\n      }\n\n      positionSlider(newPos, currentVal);\n    };\n\n    var updatePositionByValue = function (val) {\n      currentVal = val;\n      var upperBound, newPos;\n      if (options.vertical) {\n        upperBound = (container.find('.pp-slider-scale').height()-container.find('.pp-slider-button').height());\n        newPos = ((100-val)/100)*upperBound;\n      } else {\n        upperBound = (container.find('.pp-slider-scale').width()-container.find('.pp-slider-button').width());\n        newPos = (val/100)*upperBound;\n      }\n\n      positionSlider(newPos, val);\n    };\n\n    var moving = function (e) {\n      if(isMouseDown){\n        if (e.originalEvent && e.originalEvent instanceof TouchEvent) {\n          e.preventDefault();\n        }\n        updatePosition(e);\n        return false;\n      }\n    };\n\n    var dropCallback = function (e) {\n      if (isMouseDown) {\n        if (e.originalEvent && e.originalEvent instanceof TouchEvent) {\n          e.preventDefault();\n        }\n        isMouseDown = false;\n        element.val(currentVal);\n        element.trigger(\"change\");\n      }\n\n    };\n\n    updatePositionByValue(element.val());\n\n    container.find('.pp-slider-button').bind('mousedown',startSlide);\n    container.find('.pp-slider-button').bind('touchstart',startSlide);\n\n    $(document).mousemove(function(e) { moving(e); });\n    $(document).on('touchmove', function(e) { moving(e); });\n\n    $(document).mouseup(function(e){ dropCallback(e); });\n    $(document).on('touchend', function(e){ dropCallback(e); });\n\n    return {\n      updatePositionByValue: updatePositionByValue\n    }\n\n  };\n\n  /*******************************************************************************************************/\n\n  if (typeof($) == 'undefined' || $ == null) {\n    console.warn('jQuery not loaded! PPSlider is not supported');\n    return;\n  }\n\n  $.fn.PPSlider = function (options) {\n    var opts = $.extend({}, $.fn.PPSlider.defaults, options);\n\n    var ret;\n    this.each(function () {\n        ret = new PPSliderClass($(this), opts);\n    });\n    return ret;\n  }\n\n  $.fn.PPSlider.defaults = {\n    minLabel: '-',\n    maxLabel: '+',\n    moveable: true,\n    vertical: false,\n    hideTooltip: true\n  };\n\n\n})(jQuery);\n`\nmodule.exports = PPSliderClass\n","Events = require 'events'\nEnvironment = require 'models/environment'\n\nmodule.exports = class RemoveOrganismButton\n\n  constructor: (@environment, @toolbar, {@species, @imagePath}) ->\n    undefined\n\n  render: ->\n    @button = document.createElement 'div'\n    @button.classList.add 'button'\n    @button.classList.add 'no-button'\n    @button.addEventListener 'click', => @action()\n\n    image = document.createElement 'img'\n    image.setAttribute 'src', @imagePath\n    @button.appendChild image\n\n    noImage = document.createElement 'div'\n    noImage.classList.add 'no-sign'\n    @button.appendChild noImage\n\n    return @button\n\n  getView: -> @button\n\n  _disabled: false\n\n  disable: ->\n    @_disabled = true\n    @button.classList.add 'disabled'\n\n  reset: ->\n    @_disabled = false\n    @button.classList.remove 'disabled'\n\n  action: ->\n    return if @_disabled\n    @removeOrganisms()\n    Events.dispatchEvent(Environment.EVENTS.USER_REMOVED_AGENTS, {species: @species})\n\n  removeOrganisms: ->\n    for agent in @environment.agents\n      if agent.species is @species\n        agent.die()\n    @environment.removeDeadAgents()\n","PPSlider    = require 'ui/ppslider'\n\nmodule.exports = class SpeedSlider\n\n  constructor: (env) ->\n    @view = document.createElement 'div'\n    @view.setAttribute \"style\", \"height: 20px;\"\n\n    input = document.createElement 'input'\n\n    input.setAttribute \"id\", \"speed-slider\"\n    input.setAttribute \"type\", 'hidden'\n    input.setAttribute \"value\", 50\n\n    @view.appendChild input\n\n    # TODO Remove jQuery once we're no longer relying on it.\n    $( document ).ready ->\n      $(input).change ->\n        env.setSpeed(parseInt($(@).val()))\n\n      $(input).PPSlider({width: env.width})\n\n  getView: -> @view\n\n\n","InfoView = require 'ui/info-view'\n\nmodule.exports = class ToolButton\n  @INFO_TOOL: 'info-tool'\n  @CARRY_TOOL: 'carry-tool'\n  state: null\n\n  constructor: (@environment, @toolbar, {@type}) ->\n    @toolbar.registerModalButton this\n    @state = @_getState()\n    @environment.addState @type, @state\n\n  render: ->\n    @button = document.createElement 'div'\n    @button.classList.add 'button'\n    @button.addEventListener 'click', => @action()\n    @button.classList.add 'modal'\n\n    image = document.createElement 'div'\n    image.classList.add @type\n    @button.appendChild image\n\n    return @button\n\n  getView: -> @button\n\n  action: ->\n    @toolbar.activateModalButton this\n    @environment.setState @type\n\n  _getState: ->\n    return @_states[@type]\n\n  _states:\n    'info-tool':\n      enter: ->\n        @_view.setCursor \"info-tool\"\n      click: (evt) ->\n        # get clicked agent\n        agents = @getAgentsAt(evt.envX, evt.envY).filter (a)-> a.canShowInfo()\n        return unless agents.length > 0\n        agent = agents[0]\n        # Display info pop-up for that agent\n        if @infoPopup?\n          @infoPopup.setAgent(agent)\n        else\n          @infoPopup = new InfoView({agent})\n          document.getElementById('environment').appendChild @infoPopup.render()  # TODO We shouldn't be hard-coding the container...\n        for style in ['top','left','bottom','right']\n          @infoPopup.view.classList.remove style\n        if evt.envX > @width/2\n          @infoPopup.view.classList.add 'right'\n          @infoPopup.view.style.left = (evt.envX - 225) + \"px\"\n        else\n          @infoPopup.view.classList.add 'left'\n          @infoPopup.view.style.left = (evt.envX + 35) + \"px\"\n        if evt.envY > @height/2\n          @infoPopup.view.classList.add 'bottom'\n          @infoPopup.view.style.top = (evt.envY - 162) + \"px\"\n        else\n          @infoPopup.view.classList.add 'top'\n          @infoPopup.view.style.top = (evt.envY - 25) + \"px\"\n        @infoPopup.show()\n\n    'carry-tool':\n      _agent: null\n      _origin: null\n      _agentOrigin: null\n      enter: ->\n        @_view.setCursor \"carry-tool\"\n      mousedown: (evt) ->\n        agent = @getAgentAt(evt.envX, evt.envY)\n        return unless agent?\n        @pickUpAgent agent\n        @_agent = agent\n        @_origin = {x: evt.envX, y: evt.envY}\n        @_agentOrigin = agent.getLocation()\n      mousemove: (evt) ->\n        return unless @_agent?\n        dX = evt.envX - @_origin.x\n        dY = evt.envY - @_origin.y\n        @_agent.setLocation({x: @_agentOrigin.x + dX, y: @_agentOrigin.y + dY})\n      mouseup: (evt) ->\n        return unless @_agent?\n        @dropCarriedAgent()\n        @_agent = null\n      touchstart: (evt) ->\n        evt.preventDefault()\n        @send 'mousedown', evt\n      touchmove: (evt) ->\n        evt.preventDefault()\n        @send 'mousemove', evt\n      touchend: (evt) ->\n        evt.preventDefault()\n        @send 'mouseup', evt\n","AddOrganismButton = require \"ui/add-organism-button\"\nRemoveOrganismButton = require \"ui/remove-organism-button\"\nToolButton  = require 'ui/tool-button'\nEvents = require 'events'\nEnvironment = require 'models/environment'\n\nmodule.exports = class Toolbar\n\n  constructor: (@interactive) ->\n    env = @interactive.environment\n\n    @modalButtons = []\n    @toggleButtons = []\n    @organismButtons = []\n\n    @view = document.createElement 'div'\n    @view.classList.add \"toolbar\"\n    @view.setAttribute \"style\", \"height: #{env.height}px;\"\n\n    if @interactive.showPlayButton()\n      @addToggleButton \"play\", (-> env.start()),\n        \"pause\", (-> env.stop())\n      # make sure we keep the button state in sync with the environment state\n      Events.addEventListener Environment.EVENTS.PLAY, =>\n        @toggleButtons['play'].style.display=\"none\"\n        @toggleButtons['pause'].style.display=\"\"\n      Events.addEventListener Environment.EVENTS.STOP, =>\n        @toggleButtons['play'].style.display=\"\"\n        @toggleButtons['pause'].style.display=\"none\"\n    for opts in @interactive.addOrganismButtons\n      button = new AddOrganismButton env, this, opts\n      @view.appendChild button.render()\n      @organismButtons.push button\n\n      if opts.showRemoveButton\n        removeButton = new RemoveOrganismButton env, this, opts\n        @view.appendChild removeButton.render()\n        @organismButtons.push removeButton\n\n    for opts in @interactive.toolButtons\n      button = new ToolButton env, this, opts\n      @view.appendChild button.render()\n\n    if @interactive.showResetButton()\n      @addButton \"reset\", =>\n        @reset()\n        env.reset()\n\n  addButton: (type, action) ->\n    button = document.createElement 'div'\n    button.classList.add 'button'\n\n    innerButton = document.createElement 'div'\n    innerButton.classList.add type\n    button.appendChild innerButton\n\n    button.addEventListener 'click', action\n    @toggleButtons[type] = button\n    @view.appendChild button\n\n  addToggleButton: (type1, action1, type2, action2) ->\n    button1 = @addButton(type1, action1)\n    button2 = @addButton(type2, action2)\n    button2.style.display=\"none\"\n\n    button1.addEventListener 'click', ->\n      button1.style.display=\"none\"\n      button2.style.display=\"\"\n\n    button2.addEventListener 'click', ->\n      button1.style.display=\"\"\n      button2.style.display=\"none\"\n\n  registerModalButton: (btn) ->\n    @modalButtons.push btn\n\n  activateModalButton: (btn) ->\n    btn.getView().classList.add 'modal-active'\n    for button in @modalButtons\n      unless button is btn\n        button.getView().classList.remove 'modal-active'\n\n  reset: ->\n    for button in @modalButtons\n      button.getView().classList.remove 'modal-active'\n    for button in @organismButtons\n      button.reset()\n    env = @interactive.environment\n    env.setState env.UI_STATE.NONE\n\n\n\n  getView: ->\n    @view\n","require 'animated-sprite'\nhelpers       = require 'helpers'\nAnimatedAgent = require 'models/agents/animated-agent'\n\nmodule.exports = class AgentView\n\n  constructor: ({@agent}) ->\n    @imageProperties = @agent.species?.imageProperties || {}\n\n  _images: null\n  _sprites: null\n  _container: null\n\n  render: (stage, context='environment') ->\n    container = new PIXI.DisplayObjectContainer\n    sprites = {}\n    # create a texture from set of image paths\n    images = @agent.getImages({context: context})\n    for layer in images\n      sprite = @_createOrUpdateSprite layer.selectedImage\n      sprites[layer.name] = sprite\n      container.addChild(sprite)\n\n    container.position.x = @agent._x\n    container.position.y = @agent._y\n    container.agent = @agent\n\n    stage.addChild(container)\n\n    if context is 'environment' or context is 'carry-tool'\n      @_rendered = true\n      @_container = container\n      @_sprites = sprites\n      @_images = images\n\n  rerender: (stage, context='environment') ->\n    if !@_rendered\n      @render stage, context\n      return\n    newImages = @agent.getImages({context: context})\n    names = []\n    # update or create needed sprites\n    for layer,i in newImages\n      names.push layer.name\n      if not @_sprites[layer.name]?\n        sprite = @_createOrUpdateSprite layer.selectedImage\n        @_sprites[layer.name] = sprite\n        @_container.addChildAt(sprite,i)\n      else if layer.selectedImage.path? and layer.selectedImage.path != @_sprites[layer.name].texture.baseTexture.source.src\n        @_createOrUpdateSprite layer.selectedImage, @_sprites[layer.name]\n      else if @_sprites[layer.name] instanceof PIXI.AnimatedSprite\n        currentMovement = @agent.getMovement()\n        # i = _i for animation, _i in layer.selectedImage.animations when animation.movement is currentMovement\n        animation = _animation for _animation in layer.selectedImage.animations when _animation.movement is currentMovement\n        if animation and animation.path != @_sprites[layer.name].sequences[animation.movement].path\n          # this._sprites[layer.name].sequences[layer.selectedImage.animations[0].movement]\n          sprite = @_sprites[layer.name]\n          @_createOrUpdateSprite layer.selectedImage, sprite\n        else @_setSpriteProperties(@_sprites[layer.name], layer.selectedImage)\n      else\n        @_setSpriteProperties(@_sprites[layer.name], layer.selectedImage)\n\n    # remove the no-longer-needed sprites\n    for own name,sprite of @_sprites\n      if names.indexOf(name) == -1\n        @_container.removeChild sprite\n        delete @_sprites[name]\n\n    @_container.position.x = @agent._x\n    @_container.position.y = @agent._y\n\n    for layer,i in newImages\n      if (sprite = @_sprites[layer.name])? and sprite instanceof PIXI.AnimatedSprite\n        sequence = if (@agent.environment._isRunning) then @agent.getMovement() else AnimatedAgent.MOVEMENTS.STOPPED\n        return unless sequence and sprite.sequences[sequence]?\n        if sequence isnt sprite.currentSequence\n          if not sprite.playing\n            sprite.gotoAndPlay sequence\n          else\n            if sprite.sequences[sprite.currentSequence]?.interruptible\n              sprite.gotoAndPlay sequence\n            else\n              sprite.nextSequence = sequence\n        sprite.advanceTime()\n\n  remove: (stage)->\n    try\n      stage?.removeChild(@_container) if @_rendered\n    catch e\n      console.error(\"Tried to remove an agent from a stage it wasn't rendered within.\")\n    @_rendered = false\n\n  contains: (x,y)->\n    intManager = new PIXI.InteractionManager()\n    return intManager.hitTest @_container,\n      global:\n        x: x\n        y: y\n\n  defaultTextViewOptions:\n    leaves: true\n    roots: true\n\n  textView: (options = {})->\n    opts = helpers.setDefaults(options, @defaultTextViewOptions)\n    content = document.createElement 'div'\n\n    if @agent.species.defs.INFO_VIEW_PROPERTIES?\n      for own k,v of @agent.species.defs.INFO_VIEW_PROPERTIES\n        @_appendPropVals(content, k, v)\n\n    return content\n\n  _appendPropVals: (container, propLabel, propKey)->\n    prop = document.createElement 'div'\n    prop.classList.add 'agent-property'\n    prop.innerHTML = propLabel\n\n    val = document.createElement 'div'\n    val.classList.add 'agent-property-value'\n    val.innerHTML = @agent.get propKey\n\n    container.appendChild(prop)\n    container.appendChild(val)\n    return container\n\n  _createOrUpdateSprite: (image, sprite)->\n    # create a new Sprite using the texture\n    if not image.animations\n      texture = PIXI.Texture.fromImage image.path\n      if not sprite\n        sprite = new PIXI.Sprite(texture)\n      else\n        sprite.setTexture texture\n      @_setSpriteProperties(sprite, image)\n    else\n\n      setupAnimatedSprite = (image, sprite)=>\n        for animation in image.animations\n          spriteTextures = []\n          for i in [0...animation.length]\n            spriteTextures.push PIXI.Texture.fromFrame(animation.animationName+\"-\"+i)\n\n          if not sprite\n            sequences = {}\n            sequences[animation.movement]               = {frames: spriteTextures}\n            sequences[animation.movement].frameRate     = animation.frameRate if animation.frameRate\n            sequences[animation.movement].loop          = animation.loop if animation.loop\n            sequences[animation.movement].onComplete    = animation.onComplete if animation.onComplete\n            sequences[animation.movement].interruptible = animation.interruptible\n            sequences[animation.movement].path          = animation.path\n            sprite = new PIXI.AnimatedSprite sequences\n          else\n            sprite.sequences[animation.movement]                = {frames: spriteTextures}\n            sprite.sequences[animation.movement].frameRate      = animation.frameRate if animation.frameRate\n            sprite.sequences[animation.movement].loop           = animation.loop if animation.loop\n            sprite.sequences[animation.movement].onComplete     = animation.onComplete if animation.onComplete\n            sprite.sequences[animation.movement].interruptible  = animation.interruptible\n            sprite.sequences[animation.movement].path           = animation.path\n\n        sprite.nextSequence = null\n        sprite.onComplete = (sequence) =>\n          if func = sprite.sequences[sprite.currentSequence].onComplete\n            @agent[func]()\n          if sprite.nextSequence\n            sprite.gotoAndPlay sprite.nextSequence\n            sprite.nextSequence = null\n          else\n            if not sprite.sequences[sequence].loop\n              sprite.currentSequence = null\n          if sprite.nextImage?\n            setupAnimatedSprite(image, sprite)\n            sprite.nextImage = null\n\n        @_setSpriteProperties(sprite, image)\n        return sprite\n\n\n      if sprite and sprite.playing\n        sprite.nextImage = image\n      else\n        sprite = setupAnimatedSprite(image, sprite)\n\n    return sprite\n\n  _setSpriteProperties: (sprite, image)->\n    # default scale of 1 -- same size as the original image\n    scale = image.scale || 1\n    scale *= @agent.getSize()\n    sprite.scale.x = scale\n    sprite.scale.y = scale\n\n    if @imageProperties.initialFlipDirection\n      d = ExtMath.normalizeRads @agent.get('direction')\n      switch @imageProperties.initialFlipDirection\n        when \"left\"\n          sprite.scale.x *= -1 if -ExtMath.HALF_PI < d < ExtMath.HALF_PI\n        when \"right\"\n          sprite.scale.x *= -1 if -ExtMath.HALF_PI > d || d > ExtMath.HALF_PI\n        when \"up\"\n          sprite.scale.y *= -1 if 0 < d < Math.PI\n        when \"down\"\n          sprite.scale.y *= -1 if -Math.PI < d < 0\n\n    if @imageProperties.rotate\n      initialDirection = @imageProperties.initialRotationDirection || 0\n      d = ExtMath.normalizeRads @agent.get('direction')\n      dd = d - initialDirection\n      sprite.rotation = dd\n\n\n    # default anchor of 0.5 -- the image is centered on the container's position\n    sprite.anchor.x = if image.anchor?.x? then image.anchor.x else 0.5\n    sprite.anchor.y = if image.anchor?.y? then image.anchor.y else 0.5\n\n    # default position of 0 -- the image won't be shifted up/down or left/right\n    sprite.position.x = if image.position?.x? then image.position.x else 0\n    sprite.position.y = if image.position?.y? then image.position.y else 0\n    return sprite\n","cursorsClasses = [\n  \"add-agents\"\n  \"info-tool\"\n  \"carry-tool\"\n]\n\nmodule.exports = class EnvironmentView\n  showingBarriers: false\n  _backgroundSprite: null\n\n  constructor: ({@environment}) ->\n    @showingWinter = false\n    @_layers = []\n    if @environment.winterImgPath?\n      @winterImgSprite = new PIXI.TilingSprite PIXI.Texture.fromImage(@environment.winterImgPath), @environment.width, @environment.height\n      @winterImgSprite.anchor.x = 0\n      @winterImgSprite.anchor.y = 0\n      @winterImgSprite.position.x = 0\n      @winterImgSprite.position.y = 0\n\n  render: (el) ->\n    @stage = new PIXI.Stage(0xFFFFFF, true) unless @stage?\n    @renderer = new PIXI.CanvasRenderer(@environment.width, @environment.height)\n    # create a texture from an image path\n    texture = PIXI.Texture.fromImage @environment.imgPath\n\n    layer = @_getOrCreateLayer 0\n    # create a new Sprite using the texture\n    @_backgroundSprite = new PIXI.Sprite(texture)\n\n    @_backgroundSprite.anchor.x = 0\n    @_backgroundSprite.anchor.y = 0\n\n    @_backgroundSprite.position.x = 0\n    @_backgroundSprite.position.y = 0\n\n    @scaleBackground()\n\n    layer.addChild(@_backgroundSprite)\n\n    @renderBarriers(layer)\n\n    @renderAgents()\n\n    @_sortStage()\n\n    animate = =>\n      requestAnimFrame( animate )\n      for agent in @environment.agents\n\n        agent.getView().rerender(@_getOrCreateLayer(agent._viewLayer))\n\n      if @environment.carriedAgent\n        @environment.carriedAgent.getView().rerender(@_getOrCreateLayer(100), 'carry-tool')\n\n      @barrierGraphics.visible = @showingBarriers\n      @_sortStage()\n      @renderer.render(@stage)\n\n    requestAnimFrame( animate )\n\n    @view = @renderer.view\n\n    @addMouseHandlers()\n\n    return @view\n\n  repaint: ->\n    @renderer.render @stage\n\n  renderAgents: (stage) ->\n    for agent in @environment.agents\n      agent.getView().render(@_getOrCreateLayer(agent._viewLayer))\n\n  renderBarriers: (stage) ->\n    @barrierGraphics = new PIXI.Graphics()\n\n    @rerenderBarriers()\n\n    stage.addChild(@barrierGraphics)\n\n  rerenderBarriers: ->\n    while @barrierGraphics.children.length > 0\n      @barrierGraphics.removeChild(@barrierGraphics.children[0])\n    @barrierGraphics.clear()\n\n    # set a fill and line style\n    @barrierGraphics.beginFill(0xFF3300, 0.5)\n    @barrierGraphics.lineStyle(1, 0xffd900, 0.5)\n\n    # draw each barrier\n    for b,i in @environment.barriers\n      @barrierGraphics.drawRect(b.x1, b.y1, b.x2-b.x1, b.y2-b.y1)\n      text = new PIXI.Text(\"\"+i)\n      text.position = {x: b.x1+5, y: b.y1+5}\n      @barrierGraphics.addChild text\n\n    @barrierGraphics.endFill()\n    @barrierGraphics.visible = @showingBarriers\n\n  removeAgent: (agent)->\n    agent.getView().remove(@_getOrCreateLayer(agent._viewLayer))\n\n  removeCarriedAgent: (agent)->\n    agent.getView().remove(@_getOrCreateLayer(100))\n\n  setCursor: (name) ->\n    return unless @view\n    for cursorClass in cursorsClasses\n      @view.parentElement.classList.remove cursorClass\n\n    @view.parentElement.classList.add name\n\n  addWinterImage: ->\n    @showingWinter = true\n    layer = @_getOrCreateLayer(101)\n    layer.addChild(@winterImgSprite) unless !@winterImgSprite\n\n  removeWinterImage: ->\n    @showingWinter = false\n    layer = @_getOrCreateLayer(101)\n    layer.removeChild(@winterImgSprite) unless !@winterImgSprite\n\n  addMouseHandlers: ->\n    for eventName in [\"click\", \"mousedown\", \"mouseup\", \"mousemove\", \"touchstart\", \"touchmove\", \"touchend\"]\n      @view.addEventListener eventName,  (evt) =>\n        if evt instanceof TouchEvent\n          # touch events get their coordinates from a different place\n          evt.envX = evt.changedTouches[0].pageX - @view.offsetLeft\n          evt.envY = evt.changedTouches[0].pageY - @view.offsetTop\n        else\n          # use page+offset location, which remain correct after iframe zoom\n          evt.envX = evt.pageX - @view.offsetLeft\n          evt.envY = evt.pageY - @view.offsetTop\n        @environment.send evt.type, evt\n\n  updateBackground: ->\n    texture = PIXI.Texture.fromImage @environment.imgPath\n    @_backgroundSprite.setTexture texture\n    @scaleBackground()\n\n  # scales background relative to actual env size\n  scaleBackground: ->\n    [origWidth, origHeight] = [@_backgroundSprite.width, @_backgroundSprite.height]\n    if @environment.backgroundScaleX?\n      @_backgroundSprite.width = @environment.width * @environment.backgroundScaleX\n      if @environment.backgroundScaleY\n        @_backgroundSprite.height = @environment.height * @environment.backgroundScaleY\n      else\n        @_backgroundSprite.height *= (@_backgroundSprite.width / origWidth)\n    else if @environment.backgroundScaleY?\n      @_backgroundSprite.height = @environment.height * @environment.backgroundScaleY\n      @_backgroundSprite.width *= (@_backgroundSprite.height / origHeight)\n\n  _getOrCreateLayer: (idx)->\n    if not @_layers[idx]?\n      layer = new PIXI.DisplayObjectContainer\n      @_layers[idx] = layer\n      if @stage?\n        try\n          layerNo = 0\n          for own key of @._layers\n            if idx > key then layerNo++ else break\n          @stage.addChildAt layer, layerNo\n        catch\n          # FIXME We should find out if the layers at the end of the array are supposed to be above or below our new layer\n          @stage.addChild layer\n    return @_layers[idx]\n\n  _sortStage: ->\n    return unless @environment.depthPerception\n    # sort each of the stage's childrens' children by y value, ascending, so that agents on the bottom of the environment\n    # will be drawn on top of agents higher up in the environment\n    for container in @stage.children\n      container.children.sort (a,b)->\n        aIdx = if a.agent?.zIndex? then a.agent.zIndex() else (a.position.y * @environment.width + a.position.x)\n        bIdx = if b.agent?.zIndex? then b.agent.zIndex() else (b.position.y * @environment.width + b.position.x)\n        return aIdx - bIdx\n"]}