// Generated by CoffeeScript 1.9.1
(function() {
  var Agent, BasicAnimal, Environment, Events, Interactive, Rule, Species, ToolButton, Trait, env, helpers, plantSpecies, rabbitSpecies;

  helpers = require('helpers');

  Environment = require('models/environment');

  Species = require('models/species');

  Agent = require('models/agent');

  Rule = require('models/rule');

  Trait = require('models/trait');

  Interactive = require('ui/interactive');

  Events = require('events');

  ToolButton = require('ui/tool-button');

  BasicAnimal = require('models/agents/basic-animal');

  plantSpecies = require('species/fast-plants-roots');

  rabbitSpecies = require('species/varied-rabbits');

  env = require('environments/dam');

  window.model = {
    showMessage: function(message, callback) {
      return helpers.showMessage(message, this.env.getView().view.parentElement, callback);
    },
    run: function() {
      this.interactive = new Interactive({
        environment: env,
        speedSlider: false,
        addOrganismButtons: [
          {
            species: plantSpecies,
            imagePath: "images/agents/grass/medgrass.png",
            traits: [
              new Trait({
                name: "population size modifier",
                "default": 0.0,
                float: true
              }), new Trait({
                name: "roots",
                possibleValues: [1, 2, 3]
              })
            ],
            limit: 140,
            scatter: 140
          }, {
            species: rabbitSpecies,
            imagePath: "images/agents/rabbits/smallbunny.png",
            traits: [
              new Trait({
                name: "age",
                "default": 3
              })
            ],
            limit: 40,
            scatter: 40
          }
        ],
        toolButtons: [
          {
            type: ToolButton.INFO_TOOL
          }
        ]
      });
      document.getElementById('environment').appendChild(this.interactive.getEnvironmentPane());
      this.env = env;
      this.plantSpecies = plantSpecies;
      this.rabbitSpecies = rabbitSpecies;
      this._reset();
      return Events.addEventListener(Environment.EVENTS.RESET, (function(_this) {
        return function() {
          return _this._reset();
        };
      })(this));
    },
    _reset: function() {
      this.env.setBackground("images/environments/dam-year0.png");
      this._setEnvironmentProperty('water', 10);
      this.damCreated = false;
      return this._setEnvironmentProperty('water', 10, true);
    },
    chartData1: null,
    chartData2: null,
    chart1: null,
    chart2: null,
    setupCharts: function() {
      var options1, options2;
      this.chartData1 = new google.visualization.DataTable();
      this.chartData2 = new google.visualization.DataTable();
      this._setupChartData(this.chartData1);
      this._setupChartData(this.chartData2);
      options1 = this._getChartOptions("top");
      options2 = this._getChartOptions("bottom");
      this.chart1 = new google.visualization.ColumnChart(document.getElementById('chart1'));
      this.chart2 = new google.visualization.ColumnChart(document.getElementById('chart2'));
      this.chart1.draw(this.chartData1, options1);
      this.chart2.draw(this.chartData2, options2);
      return Events.addEventListener(Environment.EVENTS.STEP, (function(_this) {
        return function() {
          var agent, counts, i, j, k, len, ref;
          counts = {
            top: [0, 0, 0, 0],
            bottom: [0, 0, 0, 0]
          };
          ref = _this.env.agents;
          for (j = 0, len = ref.length; j < len; j++) {
            agent = ref[j];
            if (agent.species === _this.rabbitSpecies) {
              if (agent.getLocation().y < (_this.env.rows * _this.env._rowHeight) / 2) {
                counts.top[agent.get('size')] += 1;
              } else {
                counts.bottom[agent.get('size')] += 1;
              }
            }
          }
          for (i = k = 0; k <= 2; i = ++k) {
            _this.chartData1.setValue(i, 1, counts.top[i + 1]);
            _this.chartData2.setValue(i, 1, counts.bottom[i + 1]);
          }
          _this.chart1.draw(_this.chartData1, options1);
          return _this.chart2.draw(_this.chartData2, options2);
        };
      })(this));
    },
    _setupChartData: function(chartData) {
      chartData.addColumn('string', 'Rabbit types');
      chartData.addColumn('number', 'Number of rabbits');
      chartData.addColumn({
        type: 'string',
        role: 'style'
      });
      return chartData.addRows([["Small", 0, "color: #FF0000"], ["Medium", 0, "color: #FF0000"], ["Big", 0, "color: #FF0000"]]);
    },
    _getChartOptions: function(titleMod) {
      var options;
      return options = {
        title: 'Rabbits in ' + titleMod + ' half of the field',
        hAxis: {
          title: 'Rabbit types'
        },
        vAxis: {
          title: 'Number of rabbits',
          minValue: 0,
          maxValue: 50,
          gridlines: {
            count: 6
          }
        },
        legend: {
          position: 'none'
        },
        width: 300,
        height: 250
      };
    },
    _agentsOfSpecies: function(species) {
      var a, j, len, ref, set;
      set = [];
      ref = this.env.agents;
      for (j = 0, len = ref.length; j < len; j++) {
        a = ref[j];
        if (a.species === species) {
          set.push(a);
        }
      }
      return set;
    },
    damCreated: false,
    setupControls: function() {
      var bigHighlightRadio, createDamButton, mediumHighlightRadio, noneHighlightRadio, smallHighlightRadio;
      createDamButton = document.getElementById('build-button');
      createDamButton.onclick = (function(_this) {
        return function() {
          if (!_this.damCreated) {
            _this.damCreated = true;
            return _this.env.date = Math.floor(10000 / Environment.DEFAULT_RUN_LOOP_DELAY) - 1;
          }
        };
      })(this);
      noneHighlightRadio = document.getElementById('highlight-none');
      smallHighlightRadio = document.getElementById('highlight-small');
      mediumHighlightRadio = document.getElementById('highlight-medium');
      bigHighlightRadio = document.getElementById('highlight-big');
      noneHighlightRadio.onclick = (function(_this) {
        return function() {
          return _this._highlight(-1);
        };
      })(this);
      smallHighlightRadio.onclick = (function(_this) {
        return function() {
          return _this._highlight(1);
        };
      })(this);
      mediumHighlightRadio.onclick = (function(_this) {
        return function() {
          return _this._highlight(2);
        };
      })(this);
      bigHighlightRadio.onclick = (function(_this) {
        return function() {
          return _this._highlight(3);
        };
      })(this);
      return Events.addEventListener(Environment.EVENTS.RESET, function() {
        return noneHighlightRadio.click();
      });
    },
    _highlight: function(size) {
      var agent, j, len, ref, results;
      ref = this.env.agents;
      results = [];
      for (j = 0, len = ref.length; j < len; j++) {
        agent = ref[j];
        if (agent.species === this.rabbitSpecies) {
          results.push(agent.set('glow', agent.get('size') === size));
        } else {
          results.push(void 0);
        }
      }
      return results;
    },
    setupTimer: function() {
      var backgroundChangeable, changeInterval, waterLevel, waterLevelIndicator, yearSpan;
      backgroundChangeable = false;
      changeInterval = 10;
      waterLevel = 10;
      yearSpan = document.getElementById('year');
      waterLevelIndicator = document.getElementById('water-level-indicator');
      Events.addEventListener(Environment.EVENTS.STEP, (function(_this) {
        return function() {
          var t, waterLevelPct, year;
          if (!_this.damCreated) {
            _this.env.date = 0;
            return;
          }
          t = Math.floor(_this.env.date * Environment.DEFAULT_RUN_LOOP_DELAY / 1000);
          year = t / changeInterval;
          waterLevel = 11 - Math.min(11, year);
          waterLevelPct = waterLevel * 10;
          _this._setEnvironmentProperty('water', waterLevel);
          waterLevelIndicator.style.height = "" + waterLevelPct + "%";
          if (t % changeInterval === 0 && backgroundChangeable) {
            _this._changeBackground(year);
            yearSpan.innerHTML = "" + year;
            return backgroundChangeable = false;
          } else if (t % changeInterval !== 0) {
            return backgroundChangeable = true;
          }
        };
      })(this));
      return Events.addEventListener(Environment.EVENTS.RESET, function() {
        backgroundChangeable = false;
        yearSpan.innerHTML = "1";
        return waterLevelIndicator.style.height = "100%";
      });
    },
    _changeBackground: function(n) {
      if (!((0 < n && n < 11))) {
        return;
      }
      return this.env.setBackground("images/environments/dam-year" + n + ".png");
    },
    _setAgentProperty: function(agents, prop, val) {
      var a, j, len, results;
      results = [];
      for (j = 0, len = agents.length; j < len; j++) {
        a = agents[j];
        results.push(a.set(prop, val));
      }
      return results;
    },
    _setEnvironmentProperty: function(prop, val, all) {
      var col, j, ref, results, row;
      if (all == null) {
        all = false;
      }
      results = [];
      for (row = j = 0, ref = this.env.rows; 0 <= ref ? j <= ref : j >= ref; row = 0 <= ref ? ++j : --j) {
        if (all || row > this.env.rows / 2) {
          results.push((function() {
            var k, ref1, results1;
            results1 = [];
            for (col = k = 0, ref1 = this.env.columns; 0 <= ref1 ? k <= ref1 : k >= ref1; col = 0 <= ref1 ? ++k : --k) {
              results1.push(this.env.set(col, row, prop, val));
            }
            return results1;
          }).call(this));
        } else {
          results.push(void 0);
        }
      }
      return results;
    },
    _addAgent: function(species, properties) {
      var agent, j, len, prop;
      if (properties == null) {
        properties = [];
      }
      agent = species.createAgent();
      agent.setLocation(this.env.randomLocation());
      for (j = 0, len = properties.length; j < len; j++) {
        prop = properties[j];
        agent.set(prop[0], prop[1]);
      }
      return this.env.addAgent(agent);
    },
    setupPopulationMonitoring: function() {
      return Events.addEventListener(Environment.EVENTS.STEP, (function(_this) {
        return function() {
          _this._setPlantGrowthRate();
          _this._setRabbitGrowthRate();
          if (Math.random() < 0.1) {
            return _this._makeLandFertile();
          }
        };
      })(this));
    },
    _plantsExist: false,
    _setPlantGrowthRate: function() {
      var adder, allPlants, j, k, len, len1, plant, results, rootSize, varieties, variety;
      allPlants = this._agentsOfSpecies(this.plantSpecies);
      if (allPlants.length < 1) {
        this._plantsExist = false;
        return;
      } else {
        this._plantsExist = true;
      }
      varieties = [[], [], [], [], [], []];
      for (j = 0, len = allPlants.length; j < len; j++) {
        plant = allPlants[j];
        rootSize = plant.get("roots");
        adder = plant.getLocation().y > 250 ? 3 : 0;
        varieties[(rootSize - 1) + adder].push(plant);
      }
      results = [];
      for (k = 0, len1 = varieties.length; k < len1; k++) {
        variety = varieties[k];
        results.push(this._setGrowthRateForVariety(variety));
      }
      return results;
    },
    _setRabbitGrowthRate: function() {
      var adder, allRabbits, j, k, len, len1, rabbit, rabbitSize, results, varieties, variety;
      allRabbits = this._agentsOfSpecies(this.rabbitSpecies);
      varieties = [[], [], [], [], [], []];
      for (j = 0, len = allRabbits.length; j < len; j++) {
        rabbit = allRabbits[j];
        rabbitSize = rabbit.get("size");
        adder = rabbit.getLocation().y > 250 ? 3 : 0;
        varieties[(rabbitSize - 1) + adder].push(rabbit);
      }
      results = [];
      for (k = 0, len1 = varieties.length; k < len1; k++) {
        variety = varieties[k];
        results.push(this._dontLetRabbitsDie(variety));
      }
      return results;
    },
    _setGrowthRateForVariety: function(plants) {
      var i, j, len, plant, plantSize, populationSizeModifier, results;
      plantSize = plants.length;
      populationSizeModifier = 0.0;
      if (plantSize < 10) {
        populationSizeModifier = 0.7;
      } else if (plantSize < 15) {
        populationSizeModifier = 0.4;
      } else if (plantSize < 40) {
        populationSizeModifier = 0.1;
      } else if (plantSize < 60) {
        populationSizeModifier = 0.0;
      } else if (plantSize < 160) {
        populationSizeModifier = -0.02;
      } else if (plantSize < 190) {
        populationSizeModifier = -0.03;
      } else if (plantSize < 230) {
        populationSizeModifier = -0.05;
      } else {
        i = plantSize - 1;
        while (i > 0) {
          plants[i].die();
          i -= 5;
        }
      }
      results = [];
      for (j = 0, len = plants.length; j < len; j++) {
        plant = plants[j];
        results.push(plant.set("population size modifier", populationSizeModifier));
      }
      return results;
    },
    _dontLetRabbitsDie: function(rabbits) {
      var age, isImmortal, j, len, matingDistance, maxOffspring, metabolism, rabbit, rabbitsSize, resourceConsumptionRate, results;
      rabbitsSize = rabbits.length;
      maxOffspring = 6;
      matingDistance = 90;
      resourceConsumptionRate = 15;
      metabolism = 2;
      isImmortal = false;
      if (rabbitsSize < 3 && rabbitsSize > 0 && rabbits[0].get("size") === 3 && this._plantsExist) {
        maxOffspring = 12;
        matingDistance = 250;
        resourceConsumptionRate = 0;
        metabolism = 1;
        age = 30;
        isImmortal = true;
      } else if (rabbitsSize < 4 && rabbitsSize > 0 && rabbits[0].get("size") === 3 && this._plantsExist) {
        maxOffspring = 10;
        matingDistance = 170;
        resourceConsumptionRate = 1;
        metabolism = 1;
      } else if (rabbitsSize < 5 && rabbitsSize > 0 && rabbits[0].get("size") === 3) {
        maxOffspring = 9;
        matingDistance = 160;
        resourceConsumptionRate = 4;
        metabolism = 1;
      } else if (rabbitsSize < 6) {
        maxOffspring = 8;
        matingDistance = 140;
        resourceConsumptionRate = 5;
        metabolism = 1;
      } else if (rabbitsSize < 7) {
        maxOffspring = 7;
        matingDistance = 130;
        resourceConsumptionRate = 8;
        metabolism = 2;
      } else if (rabbitsSize < 20) {

      } else if (rabbitsSize < 25) {
        maxOffspring = 5;
        matingDistance = 80;
        resourceConsumptionRate = 16;
        metabolism = 3;
      } else if (rabbitsSize < 35) {
        maxOffspring = 2;
        matingDistance = 80;
        resourceConsumptionRate = 18;
        metabolism = 5;
      } else {
        maxOffspring = 0;
        resourceConsumptionRate = 18;
        metabolism = 9;
      }
      results = [];
      for (j = 0, len = rabbits.length; j < len; j++) {
        rabbit = rabbits[j];
        rabbit.set("max offspring", maxOffspring);
        rabbit.set("mating distance", matingDistance);
        rabbit.set("resource consumption rate", resourceConsumptionRate);
        rabbit.set("metabolism", metabolism);
        results.push(rabbit.set("is immortal", isImmortal));
      }
      return results;
    },
    _makeLandFertile: function() {},
    preload: ["images/agents/grass/medgrass.png", "images/agents/rabbits/smallbunny.png", "images/environments/dam-year0.png", "images/environments/dam-year1.png", "images/environments/dam-year2.png", "images/environments/dam-year3.png", "images/environments/dam-year4.png", "images/environments/dam-year5.png", "images/environments/dam-year6.png", "images/environments/dam-year7.png", "images/environments/dam-year8.png", "images/environments/dam-year9.png", "images/environments/dam-year10.png"]
  };

  window.onload = function() {
    return helpers.preload([model, env, rabbitSpecies, plantSpecies], function() {
      model.run();
      model.setupControls();
      model.setupCharts();
      model.setupTimer();
      return model.setupPopulationMonitoring();
    });
  };

}).call(this);
